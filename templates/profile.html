{% extends "base.html" %}
{% block content %}
<div class="mb-4"><h1><i class="bi bi-person-circle me-2"></i>Member Profile</h1></div>
{% if success %}<div class="alert alert-success">{{success}}</div>{% endif %}
{% if request.query_params.get('welcome') == 'true' and not user.member %}
<div class="alert alert-info">
<h5><i class="bi bi-info-circle me-2"></i>Welcome to South Austin Bass Club!</h5>
<p class="mb-2">Your account has been created as a <strong>guest</strong>. To become a member:</p>
<ol class="mb-2">
<li>Pay the $25 annual membership fee</li>
<li>Contact an admin to verify your payment</li>
<li>Once verified, you'll gain access to polls, roster, and voting privileges</li>
</ol>
<p class="mb-0"><small>Until then, you can browse public pages and view your profile.</small></p>
</div>
{% endif %}

<div class="row g-4">
<div class="col-lg-8">
<div class="card">
<div class="card-header d-flex justify-content-between align-items-center">
<h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Account Information</h5>
<button class="btn btn-sm btn-primary" onclick="toggleEdit()" id="editBtn"><i class="bi bi-pencil me-1"></i>Edit</button>
</div>
<div class="card-body">
<!-- View Mode -->
<div id="viewMode">
<div class="row">
<div class="col-md-8">
<table class="table table-borderless">
<tr><th style="width:40%">Name</th><td>{{user.name}}</td></tr>
<tr><th>Email</th><td>{{user.email or 'Not provided'}}</td></tr>
<tr><th>Phone</th><td>{{user.phone or 'Not provided'}}</td></tr>
<tr><th>Year Joined</th><td>{{user.year_joined or 'Not specified'}}</td></tr>
<tr><th>Status</th><td>
{% if user.member %}<span class="badge bg-success">Member</span>{% else %}<span class="badge bg-secondary">Guest</span>{% endif %}
{% if user.is_admin %}<span class="badge bg-danger">Admin</span>{% endif %}
</td></tr>
</table>
</div>
<div class="col-md-4 text-center">
<img src="/static/sabc_logo.png" alt="SABC Logo" class="img-fluid rounded" style="max-width: 150px;">
</div>
</div>
</div>

<!-- Edit Mode -->
<div id="editMode" style="display:none">
<form method="POST" action="/profile/update">
<div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" name="email" value="{{user.email or ''}}" required></div>
<div class="mb-3"><label class="form-label">Phone</label><input type="tel" class="form-control" name="phone" id="phoneInput" value="{{user.phone or ''}}" placeholder="(555) 123-4567" maxlength="14"></div>
<div class="mb-3"><label class="form-label">Year Joined</label><input type="number" class="form-control" name="year_joined" value="{{user.year_joined or 2024}}" min="1981" max="2030"></div>

<!-- Password Change Section -->
<hr class="my-4">
<h6 class="text-primary"><i class="bi bi-key me-2"></i>Change Password</h6>
<p class="text-muted small mb-3">Leave password fields blank to keep your current password.</p>
<div class="mb-3">
    <label class="form-label">Current Password</label>
    <input type="password" class="form-control" name="current_password" placeholder="Enter your current password">
    <div class="form-text">Required to change your password</div>
</div>
<div class="mb-3">
    <label class="form-label">New Password</label>
    <input type="password" class="form-control" name="new_password" placeholder="Enter new password (8+ characters)" minlength="8">
</div>
<div class="mb-3">
    <label class="form-label">Confirm New Password</label>
    <input type="password" class="form-control" name="confirm_password" placeholder="Confirm new password">
</div>

<div class="d-flex gap-2">
<button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>Save</button>
<button type="button" class="btn btn-secondary" onclick="cancelEdit()"><i class="bi bi-x-lg me-1"></i>Cancel</button>
</div>
</form>

<hr class="my-4">
<div class="alert alert-warning">
<h6><i class="bi bi-exclamation-triangle me-2"></i>Danger Zone</h6>
<p class="mb-2">Permanently delete your account and all data. This cannot be undone.</p>
<button type="button" class="btn btn-outline-danger btn-sm" onclick="startDeleteProcess()"><i class="bi bi-trash me-1"></i>Delete Account</button>
</div>
</div>
</div>
</div>
</div>

<div class="col-lg-4">
<div class="card">
<div class="card-header"><h5><i class="bi bi-trophy me-2"></i>Angler Stats</h5></div>
<div class="card-body">
<div class="row text-center g-3 mb-4">
<div class="col-4"><div class="h3 text-primary">{{stats.tournaments}}</div><small>Tournaments</small></div>
<div class="col-4"><div class="h3 text-info">{{stats.best_weight|int if stats.best_weight == 0 else "%.1f"|format(stats.best_weight)}}</div><small>Best Weight</small></div>
<div class="col-4"><div class="h3 text-success">{{"%.1f"|format(stats.big_bass)}} lbs</div><small>Biggest Bass</small></div>
</div>

<h6 class="text-success mb-3"><i class="bi bi-people me-1"></i>Team Finishes</h6>

<!-- Tabs Navigation -->
<ul class="nav nav-pills nav-sm mb-3 justify-content-center" id="finishTabs" role="tablist">
<li class="nav-item" role="presentation">
<button class="nav-link active" id="current-year-tab" data-bs-toggle="pill" data-bs-target="#current-year" type="button" role="tab" aria-controls="current-year" aria-selected="true">{{current_year}}</button>
</li>
<li class="nav-item" role="presentation">
<button class="nav-link" id="all-time-tab" data-bs-toggle="pill" data-bs-target="#all-time" type="button" role="tab" aria-controls="all-time" aria-selected="false">Since 2022</button>
</li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="finishTabsContent">
<!-- Current Year Tab -->
<div class="tab-pane fade show active" id="current-year" role="tabpanel" aria-labelledby="current-year-tab">
<div class="row text-center g-2 mb-3">
<div class="col-4"><div class="p-2 rounded" style="background-color: #fff8dc; border: 1px solid #ffd700;"><div class="h4" style="color: #ffd700;"><i class="bi bi-trophy"></i></div><div class="h5" style="color: #b8860b;">{{stats.current_first}}</div><small style="color: #b8860b;">1st</small></div></div>
<div class="col-4"><div class="p-2 rounded" style="background-color: #f5f5f5; border: 1px solid #c0c0c0; background-image: linear-gradient(135deg, #e8e8e8 0%, #f5f5f5 50%, #e8e8e8 100%);"><div class="h4" style="color: #a8a8a8;"><i class="bi bi-award"></i></div><div class="h5" style="color: #2c2c2c;">{{stats.current_second}}</div><small style="color: #2c2c2c;">2nd</small></div></div>
<div class="col-4"><div class="p-2 bg-warning bg-opacity-25 rounded"><div class="h4" style="color:#cd7f32"><i class="bi bi-award"></i></div><div class="h5" style="color:#cd7f32">{{stats.current_third}}</div><small>3rd</small></div></div>
</div>

<!-- AOY Position for Current Year -->
<div class="text-center">
<div class="p-3 bg-warning bg-opacity-10 rounded">
<i class="bi bi-star text-warning h4 mb-1"></i>
<div class="h4 text-warning">{% if stats.aoy_position %}#{{stats.aoy_position}}{% else %}?{% endif %}</div>
<small>Current AOY Position</small>
</div>
</div>
</div>

<!-- All Time Tab -->
<div class="tab-pane fade" id="all-time" role="tabpanel" aria-labelledby="all-time-tab">
<div class="row text-center g-2 mb-3">
<div class="col-4"><div class="p-2 rounded" style="background-color: #fff8dc; border: 1px solid #ffd700;"><div class="h4" style="color: #ffd700;"><i class="bi bi-trophy"></i></div><div class="h5" style="color: #b8860b;">{{stats.all_time_first}}</div><small style="color: #b8860b;">1st</small></div></div>
<div class="col-4"><div class="p-2 rounded" style="background-color: #f5f5f5; border: 1px solid #c0c0c0; background-image: linear-gradient(135deg, #e8e8e8 0%, #f5f5f5 50%, #e8e8e8 100%);"><div class="h4" style="color: #a8a8a8;"><i class="bi bi-award"></i></div><div class="h5" style="color: #2c2c2c;">{{stats.all_time_second}}</div><small style="color: #2c2c2c;">2nd</small></div></div>
<div class="col-4"><div class="p-2 bg-warning bg-opacity-25 rounded"><div class="h4" style="color:#cd7f32"><i class="bi bi-award"></i></div><div class="h5" style="color:#cd7f32">{{stats.all_time_third}}</div><small>3rd</small></div></div>
</div>
</div>
</div>

</div>
</div>
</div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header bg-danger text-white">
<h5><i class="bi bi-exclamation-triangle me-2"></i>Delete Account</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div class="alert alert-danger"><strong>⚠️ Warning:</strong> This will permanently delete your account.</div>
<p><strong>You will lose:</strong> Account access to the club system</p>
<p><strong>Tournament results will remain for record-keeping.</strong></p>
<p><strong>Type "DELETE" to confirm:</strong></p>
<form method="POST" action="/profile/delete" id="deleteForm">
<input type="text" class="form-control" name="confirm" placeholder="Type DELETE to confirm" required id="deleteConfirm">
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button type="submit" form="deleteForm" class="btn btn-danger" id="deleteSubmitBtn" disabled><i class="bi bi-trash me-1"></i>Delete Account</button>
</div>
</div>
</div>
</div>

<script>
function toggleEdit() {
document.getElementById('viewMode').style.display = 'none';
document.getElementById('editMode').style.display = 'block';
document.getElementById('editBtn').innerHTML = '<i class="bi bi-eye me-1"></i>View';
document.getElementById('editBtn').onclick = cancelEdit;
}

function cancelEdit() {
document.getElementById('viewMode').style.display = 'block';
document.getElementById('editMode').style.display = 'none';
document.getElementById('editBtn').innerHTML = '<i class="bi bi-pencil me-1"></i>Edit';
document.getElementById('editBtn').onclick = toggleEdit;
}

function startDeleteProcess() {
new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

document.getElementById('deleteConfirm').addEventListener('input', function(e) {
const btn = document.getElementById('deleteSubmitBtn');
btn.disabled = e.target.value !== 'DELETE';
});

// Phone number formatting
const phoneInput = document.getElementById('phoneInput');
if (phoneInput) {
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Remove all non-digits
        
        if (value.length === 0) {
            e.target.value = '';
            return;
        }
        
        // Remove leading 1 if present
        if (value.length === 11 && value[0] === '1') {
            value = value.substring(1);
        }
        
        // Format the number as (XXX) XXX-XXXX
        if (value.length <= 3) {
            e.target.value = '(' + value;
        } else if (value.length <= 6) {
            e.target.value = '(' + value.substring(0, 3) + ') ' + value.substring(3);
        } else if (value.length <= 10) {
            e.target.value = '(' + value.substring(0, 3) + ') ' + value.substring(3, 6) + '-' + value.substring(6);
        } else {
            // Don't allow more than 10 digits
            e.target.value = '(' + value.substring(0, 3) + ') ' + value.substring(3, 6) + '-' + value.substring(6, 10);
        }
    });
    
    // Also format on blur to ensure consistency
    phoneInput.addEventListener('blur', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        if (value.length === 10) {
            e.target.value = '(' + value.substring(0, 3) + ') ' + value.substring(3, 6) + '-' + value.substring(6);
        } else if (value.length === 0) {
            e.target.value = '';
        }
    });
}
</script>
{% endblock %}