{% extends "base.html" %}
{% from 'macros.html' import alert %}

{% block title %}Admin - Tournaments{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Tournament Management</h2>
        <button class="btn btn-primary" onclick="window.location.href='/admin/events'">
            <i class="fas fa-calendar-plus"></i> Manage Events
        </button>
    </div>

    {% if tournaments %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th>Event Name</th>
                    <th>Lake</th>
                    <th>Entry Fee</th>
                    <th>Participants</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for tournament in tournaments %}
                <tr>
                    <td>{{ tournament.date }}</td>
                    <td>{{ tournament.name }}</td>
                    <td>{{ tournament.lake_name or 'TBD' }}</td>
                    <td>${{ "%.2f"|format(tournament.entry_fee) }}</td>
                    <td>{{ tournament.total_participants }}</td>
                    <td>
                        {% if tournament.complete %}
                            <span class="badge bg-success">Complete</span>
                        {% else %}
                            <span class="badge bg-warning">In Progress</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <a href="/tournaments/{{ tournament.id }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> View
                            </a>
                            {% if not tournament.complete %}
                            <button class="btn btn-sm btn-outline-success" onclick="enterResults({{ tournament.id }})">
                                <i class="fas fa-plus"></i> Results
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-outline-secondary"
                                    onclick="toggleComplete({{ tournament.id }}, {{ tournament.complete|lower }})"
                                    title="Toggle completion status">
                                {% if tournament.complete %}
                                    <i class="fas fa-undo"></i> Mark Upcoming
                                {% else %}
                                    <i class="fas fa-check"></i> Mark Complete
                                {% endif %}
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">
        <h4>No Tournaments Found</h4>
        <p>No tournaments have been created yet. Create events first, then tournaments can be created for those events.</p>
        <a href="/admin/events" class="btn btn-primary">Manage Events</a>
    </div>
    {% endif %}
</div>

<script>
function enterResults(tournamentId) {
    // This would open a modal or navigate to results entry
    window.location.href = `/tournaments/${tournamentId}`;
}

function toggleComplete(tournamentId, currentStatus) {
    const action = currentStatus ? 'upcoming' : 'complete';
    const confirmMessage = `Are you sure you want to mark this tournament as ${action}?`;

    if (confirm(confirmMessage)) {
        fetch(`/admin/tournaments/${tournamentId}/toggle-complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                alert(data.message);
                // Reload the page to reflect changes
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating tournament status');
        });
    }
}
</script>
{% endblock %}
