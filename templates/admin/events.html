{% extends "base.html" %}

{% block title %}Manage Events - South Austin Bass Club{% endblock %}

{% block content %}
<div class="container">
    <div class="mb-4">
        <h1 class="display-5">
            <i class="bi bi-calendar3 me-2"></i>Manage Events
        </h1>
        <p class="lead text-muted">Create and manage tournament events</p>
    </div>

    <!-- Add Event Form -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-plus-circle me-2"></i>Add New Event
            </h5>
        </div>
        <div class="card-body">
            {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
            {% endif %}
            
            <form method="POST" action="/admin/events/create">
                <!-- Row 1: Event Date, Event Type, Event Name, Description -->
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="date" class="form-label">Event Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="date" name="date" required>
                    </div>
                    <div class="col-md-2">
                        <label for="event_type" class="form-label">Event Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="event_type" name="event_type" required>
                            <option value="sabc_tournament">SABC Tournament</option>
                            <option value="holiday">Holiday</option>
                            <option value="other_tournament">Other Tournament</option>
                            <option value="club_event">Club Event</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="name" class="form-label">Event Name <span id="name-required" class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name"
                               placeholder="e.g., August Tournament" required>
                    </div>
                    <div class="col-md-3">
                        <label for="description" class="form-label">Description <span class="text-muted">(Optional)</span></label>
                        <input type="text" class="form-control" id="description" name="description"
                               placeholder="e.g., Location details or notes">
                    </div>
                </div>

                <!-- Row 2: SABC Tournament-specific fields -->
                <div id="sabc-tournament-fields" class="row g-3 mt-2" style="display: none;">
                    <div class="col-md-2">
                        <label for="start_time" class="form-label">Start Time <span class="text-danger">*</span></label>
                        <input type="time" class="form-control" id="start_time" name="start_time">
                    </div>
                    <div class="col-md-2">
                        <label for="weigh_in_time" class="form-label">Weigh-in Time <span class="text-danger">*</span></label>
                        <input type="time" class="form-control" id="weigh_in_time" name="weigh_in_time">
                    </div>
                    <div class="col-md-2">
                        <label for="lake_name" class="form-label">Lake <span class="text-danger">*</span></label>
                        <select class="form-select" id="lake_name" name="lake_name">
                            <option value="">-- Select Lake --</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="ramp_name" class="form-label">Ramp <span class="text-danger">*</span></label>
                        <select class="form-select" id="ramp_name" name="ramp_name" disabled required>
                            <option value="">-- Select Ramp --</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="entry_fee" class="form-label">Entry Fee</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="entry_fee" name="entry_fee" value="25.00" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label for="fish_limit" class="form-label">Fish Limit</label>
                        <input type="number" class="form-control" id="fish_limit" name="fish_limit" value="5" min="1" max="10">
                    </div>
                </div>


                <!-- Row 2: Other Tournament fields -->
                <div id="other-tournament-fields" class="row g-3 mt-2" style="display: none;">
                    <div class="col-md-3">
                        <label for="other_start_time" class="form-label">Start Time <span class="text-muted">(Optional)</span></label>
                        <input type="time" class="form-control" id="other_start_time" name="start_time">
                    </div>
                    <div class="col-md-3">
                        <label for="other_weigh_in_time" class="form-label">Weigh-in Time <span class="text-muted">(Optional)</span></label>
                        <input type="time" class="form-control" id="other_weigh_in_time" name="weigh_in_time">
                    </div>
                    <div class="col-md-3">
                        <label for="other_lake_name" class="form-label">Lake</label>
                        <select class="form-select" id="other_lake_name" name="lake_name">
                            <option value="">-- Select Lake --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="other_ramp_name" class="form-label">Ramp <span class="text-muted">(Optional)</span></label>
                        <select class="form-select" id="other_ramp_name" name="ramp_name" disabled>
                            <option value="">-- Select Ramp --</option>
                        </select>
                    </div>
                </div>

                <!-- Row 3: Description for Other Tournaments -->
                <div id="other-tournament-description" class="row g-3 mt-2" style="display: none;">
                    <div class="col-md-12">
                        <label for="other_description" class="form-label">Description <span class="text-muted">(Optional)</span></label>
                        <textarea class="form-control" id="other_description" rows="2" placeholder="Additional details about the tournament or event..."></textarea>
                    </div>
                </div>

                <!-- Row 2: Club Event fields -->
                <div id="club-event-fields" class="row g-3 mt-2" style="display: none;">
                    <div class="col-md-12">
                        <label for="club_description" class="form-label">Description <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="club_description" rows="3" placeholder="Describe the club event (meeting agenda, activities, location, etc.)"></textarea>
                    </div>
                </div>

                <!-- Other event types fields -->
                <div id="other-fields" class="row g-3 mt-2" style="display: none;">
                    <!-- No additional fields needed - description is in main row -->
                </div>

                <!-- SABC Tournament-only fields (hidden now, merged above) -->
                <div id="sabc-fields" class="row g-3 mt-2" style="display: none;">
                </div>
                
                <!-- Holiday-specific fields -->
                <div id="holiday-fields" class="row g-3 mt-2" style="display: none;">
                </div>
                
                <!-- General event options -->
                <div class="row g-3 mt-2">
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Add Event
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Tabs -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark p-0">
            <ul class="nav nav-tabs nav-fill" id="eventTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active text-light" id="sabc-tab" data-bs-toggle="tab" data-bs-target="#sabc-events" type="button" role="tab" aria-controls="sabc-events" aria-selected="true">
                        <i class="bi bi-trophy me-2"></i>SABC Tournaments
                        <span class="badge bg-primary ms-2" id="sabc-count">{{ events|selectattr('event_type', 'equalto', 'sabc_tournament')|list|length }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link text-light" id="holidays-tab" data-bs-toggle="tab" data-bs-target="#holidays-events" type="button" role="tab" aria-controls="holidays-events" aria-selected="false">
                        <i class="bi bi-calendar-heart me-2"></i>Holidays
                        <span class="badge bg-info ms-2" id="holidays-count">{{ events|selectattr('event_type', 'equalto', 'holiday')|list|length }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link text-light" id="other-tab" data-bs-toggle="tab" data-bs-target="#other-events" type="button" role="tab" aria-controls="other-events" aria-selected="false">
                        <i class="bi bi-calendar-plus me-2"></i>Other Events
                        <span class="badge bg-warning ms-2" id="other-count">{{ events|selectattr('event_type', 'in', ['other_tournament', 'club_event'])|list|length }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link text-light" id="past-tab" data-bs-toggle="tab" data-bs-target="#past-events-tab" type="button" role="tab" aria-controls="past-events-tab" aria-selected="false">
                        <i class="bi bi-calendar-x me-2"></i>Past Events
                        <span class="badge bg-secondary ms-2" id="past-count">{{ total_past }}</span>
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body p-0">
            <div class="tab-content" id="eventTabsContent">
                
                <!-- SABC Tournaments Tab -->
                <div class="tab-pane fade show active" id="sabc-events" role="tabpanel" aria-labelledby="sabc-tab">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-secondary text-white border-bottom">
                        <h6 class="mb-0"><i class="bi bi-trophy me-2 text-primary"></i>SABC Tournament Management</h6>
                    </div>
                    
                    <!-- Search and Filter for SABC -->
                    <div class="p-3 border-bottom bg-dark">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="sabc-search" placeholder="Search tournaments..." onkeyup="filterEvents('sabc')">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="sabc-year-filter" onchange="filterEvents('sabc')">
                                    <option value="">All Years</option>
                                    {% for year in range(2023, 2027) %}
                                    <option value="{{ year }}" {% if year == 2025 %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="sabc-status-filter" onchange="filterEvents('sabc')">
                                    <option value="">All Status</option>
                                    <option value="complete">Complete</option>
                                    <option value="upcoming">Upcoming</option>
                                    <option value="no-poll">No Poll</option>
                                    <option value="poll-active">Poll Active</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="sabc-lake-filter" onchange="filterEvents('sabc')">
                                    <option value="">All Lakes</option>
                                    <option value="travis">Lake Travis</option>
                                    <option value="austin">Lake Austin</option>
                                    <option value="bastrop">Lake Bastrop</option>
                                    <option value="buchanan">Lake Buchanan</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters('sabc')">
                                    <i class="bi bi-x-circle me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% set sabc_events = events|selectattr('event_type', 'equalto', 'sabc_tournament')|list %}
                    {% include 'admin/events_table.html' with context %}
                </div>

                <!-- Federal Holidays Tab -->
                <div class="tab-pane fade" id="holidays-events" role="tabpanel" aria-labelledby="holidays-tab">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-secondary text-white border-bottom">
                        <h6 class="mb-0"><i class="bi bi-calendar-heart me-2 text-info"></i>Holiday Calendar</h6>
                    </div>
                    
                    <!-- Search and Filter for Holidays -->
                    <div class="p-3 border-bottom bg-dark">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="holidays-search" placeholder="Search holidays..." onkeyup="filterEvents('holidays')">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="holidays-year-filter" onchange="filterEvents('holidays')">
                                    <option value="">All Years</option>
                                    {% for year in range(2025, 2066) %}
                                    <option value="{{ year }}" {% if year == 2025 %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters('holidays')">
                                    <i class="bi bi-x-circle me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% set sabc_events = events|selectattr('event_type', 'equalto', 'holiday')|list %}
                    {% include 'admin/events_table.html' with context %}
                </div>

                <!-- Other Events Tab -->
                <div class="tab-pane fade" id="other-events" role="tabpanel" aria-labelledby="other-tab">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-secondary text-white border-bottom">
                        <h6 class="mb-0"><i class="bi bi-calendar-plus me-2 text-warning"></i>Other Events & Tournaments</h6>
                    </div>
                    
                    <!-- Search and Filter for Other Events -->
                    <div class="p-3 border-bottom bg-dark">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="other-search" placeholder="Search events..." onkeyup="filterEvents('other')">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="other-year-filter" onchange="filterEvents('other')">
                                    <option value="">All Years</option>
                                    {% for year in range(2023, 2027) %}
                                    <option value="{{ year }}" {% if year == 2025 %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="other-type-filter" onchange="filterEvents('other')">
                                    <option value="">All Types</option>
                                    <option value="other_tournament">Other Tournaments</option>
                                    <option value="club_event">Club Events</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters('other')">
                                    <i class="bi bi-x-circle me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% set sabc_events = events|selectattr('event_type', 'in', ['other_tournament', 'club_event'])|list %}
                    {% include 'admin/events_table.html' with context %}
                </div>

                <!-- Past Events Tab -->
                <div class="tab-pane fade" id="past-events-tab" role="tabpanel" aria-labelledby="past-tab">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-secondary text-white border-bottom">
                        <h6 class="mb-0"><i class="bi bi-calendar-x me-2"></i>Past Events Archive</h6>
                    </div>
                    
                    <!-- Search and Filter for Past Events -->
                    <div class="p-3 border-bottom bg-dark">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="past-search" placeholder="Search past events..." onkeyup="filterEvents('past')">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="past-year-filter" onchange="filterEvents('past')">
                                    <option value="">All Years</option>
                                    {% for year in range(2020, 2025) %}
                                    <option value="{{ year }}">{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="past-type-filter" onchange="filterEvents('past')">
                                    <option value="">All Types</option>
                                    <option value="sabc_tournament">SABC</option>
                                    <option value="holiday">Holidays</option>
                                    <option value="other_tournament">Other Tournaments</option>
                                    <option value="club_event">Club Events</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="past-results-filter" onchange="filterEvents('past')">
                                    <option value="">All Results</option>
                                    <option value="has-results">Has Results</option>
                                    <option value="no-results">No Results</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters('past')">
                                    <i class="bi bi-x-circle me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% include 'admin/past_events_table.html' with context %}
                </div>

            </div>
        </div>
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/admin/events/edit" id="editEventForm">
                <div class="modal-body">
                    <input type="hidden" id="edit_event_id" name="event_id">
                    <div class="mb-3">
                        <label for="edit_date" class="form-label">Event Date</label>
                        <input type="date" class="form-control" id="edit_date" name="date" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_event_type" class="form-label">Event Type</label>
                        <select class="form-select" id="edit_event_type" name="event_type" required>
                            <option value="sabc_tournament">SABC Tournament</option>
                            <option value="holiday">Holiday</option>
                            <option value="other_tournament">Other Tournament</option>
                            <option value="club_event">Club Event</option>
                        </select>
                    </div>
                    <div class="mb-3" id="edit_poll_closes_container" style="display: none;">
                        <label for="edit_poll_closes_date" class="form-label">Poll Closes Date & Time</label>
                        <input type="datetime-local" class="form-control" id="edit_poll_closes_date" name="poll_closes_date" 
                               title="Date and time when tournament location poll closes">
                        <div class="form-text">Only shown for SABC tournaments with existing polls</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Event Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="edit_description" name="description">
                    </div>
                    
                    <!-- Tournament-specific fields -->
                    <div id="edit-tournament-fields" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="edit_start_time" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="edit_start_time" name="start_time">
                            </div>
                            <div class="col-md-6">
                                <label for="edit_weigh_in_time" class="form-label">Weigh-in Time</label>
                                <input type="time" class="form-control" id="edit_weigh_in_time" name="weigh_in_time">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="edit_lake_name" class="form-label">Lake</label>
                                <select class="form-select" id="edit_lake_name" name="lake_name">
                                    <option value="">-- Select Lake --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="edit_ramp_name" class="form-label">Ramp</label>
                                <select class="form-select" id="edit_ramp_name" name="ramp_name" disabled>
                                    <option value="">-- Select Ramp --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SABC Tournament-only fields -->
                    <div id="edit-sabc-fields" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="edit_entry_fee" class="form-label">Entry Fee</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="edit_entry_fee" name="entry_fee" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="edit_fish_limit" class="form-label">Fish Limit</label>
                                <input type="number" class="form-control" id="edit_fish_limit" name="fish_limit" min="1" max="10">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Holiday-specific fields -->
                    <div id="edit-holiday-fields" style="display: none;">
                    </div>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Event Modal -->
<div class="modal fade" id="deleteEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Delete Event</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Warning:</strong> You are about to delete an event. This action cannot be undone.
                </div>
                <p>Event: <strong id="delete-current-event-name"></strong></p>
                <p id="delete-current-dependencies-warning" class="text-warning" style="display: none;">
                    <i class="bi bi-info-circle me-1"></i>This event has associated data that will also be removed:
                    <ul class="mt-2">
                        <li>Polls and poll votes (if any)</li>
                        <li>Tournament setup (if not complete)</li>
                    </ul>
                </p>
                <p class="mt-3">To confirm deletion, please type <code>DELETE</code> in the field below:</p>
                <input type="text" class="form-control" id="delete-current-confirmation" placeholder="Type DELETE to confirm">
                <input type="hidden" id="delete-current-event-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteCurrentEvent()">
                    <i class="bi bi-trash me-1"></i>Delete Event
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Past Event Modal -->
<div class="modal fade" id="deletePastEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Delete Past Event</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Warning:</strong> You are about to delete a past event. This action cannot be undone.
                </div>
                <p>Event: <strong id="delete-event-name"></strong></p>
                <p id="delete-dependencies-warning" class="text-warning" style="display: none;">
                    <i class="bi bi-info-circle me-1"></i>This event has associated data that will also be removed:
                    <ul class="mt-2">
                        <li>Polls and poll votes (if any)</li>
                        <li>Tournament setup (if no results exist)</li>
                    </ul>
                </p>
                <p class="mt-3">To confirm deletion, please type <code>DELETE</code> in the field below:</p>
                <input type="text" class="form-control" id="delete-confirmation" placeholder="Type DELETE to confirm">
                <input type="hidden" id="delete-event-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeletePastEvent()">
                    <i class="bi bi-trash me-1"></i>Delete Event
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// This section is handled by the main DOMContentLoaded listener below

// Load lakes when page loads
let lakesData = [];
function loadLakes() {
    fetch('/api/lakes')
        .then(response => response.json())
        .then(lakes => {
            lakesData = lakes;
            // Populate create form lake select
            const createLakeSelect = document.getElementById('lake_name');
            if (createLakeSelect) {
                createLakeSelect.innerHTML = '<option value="">-- Select Lake --</option>';
                lakes.forEach(lake => {
                    const option = document.createElement('option');
                    option.value = lake.name;
                    option.textContent = lake.name;
                    option.dataset.lakeKey = lake.key;
                    createLakeSelect.appendChild(option);
                });
            }
            
            // Populate edit form lake select
            const editLakeSelect = document.getElementById('edit_lake_name');
            if (editLakeSelect) {
                editLakeSelect.innerHTML = '<option value="">-- Select Lake --</option>';
                lakes.forEach(lake => {
                    const option = document.createElement('option');
                    option.value = lake.name;
                    option.textContent = lake.name;
                    option.dataset.lakeKey = lake.key;
                    editLakeSelect.appendChild(option);
                });
            }
        });
}

// Load ramps when lake is selected
function loadRamps(lakeName, rampSelectId = 'edit_ramp_name') {
    const rampSelect = document.getElementById(rampSelectId);
    
    if (!rampSelect) return;
    
    if (!lakeName) {
        rampSelect.innerHTML = '<option value="">-- Select Ramp --</option>';
        rampSelect.disabled = true;
        return;
    }
    
    // Find the lake key from lakesData
    const lake = lakesData.find(l => l.name === lakeName);
    if (!lake) {
        rampSelect.innerHTML = '<option value="">-- Select Ramp --</option>';
        rampSelect.disabled = true;
        return;
    }
    
    fetch(`/api/lakes/${lake.key}/ramps`)
        .then(response => response.json())
        .then(data => {
            rampSelect.innerHTML = '<option value="">-- Select Ramp --</option>';
            if (data.ramps && data.ramps.length > 0) {
                data.ramps.forEach(ramp => {
                    const option = document.createElement('option');
                    // Handle both string ramps and object ramps with name property
                    const rampName = typeof ramp === 'string' ? ramp : ramp.name;
                    option.value = rampName;
                    option.textContent = rampName;
                    rampSelect.appendChild(option);
                });
                rampSelect.disabled = false;
            } else {
                rampSelect.disabled = true;
            }
        });
}

function editEvent(id, date, eventType, name, description, hasPoll, pollActive) {
    // Load lakes if not already loaded
    if (lakesData.length === 0) {
        loadLakes();
    }
    
    // Fetch complete event data
    fetch(`/admin/events/${id}/info`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error loading event data: ' + data.error);
                return;
            }
            
            // Populate basic fields
            document.getElementById('edit_event_id').value = data.id;
            document.getElementById('edit_date').value = data.date;
            document.getElementById('edit_event_type').value = data.event_type;
            document.getElementById('edit_name').value = data.name;
            document.getElementById('edit_description').value = data.description;
            
            // Populate tournament fields
            document.getElementById('edit_start_time').value = data.start_time || '06:00';
            document.getElementById('edit_weigh_in_time').value = data.weigh_in_time || '15:00';
            document.getElementById('edit_entry_fee').value = data.entry_fee || 25.00;
            document.getElementById('edit_fish_limit').value = data.fish_limit || 5;
            
            // Set lake and load ramps
            const lakeSelect = document.getElementById('edit_lake_name');
            lakeSelect.value = data.lake_name || '';
            if (data.lake_name) {
                loadRamps(data.lake_name);
                // Set ramp value after ramps are loaded
                setTimeout(() => {
                    document.getElementById('edit_ramp_name').value = data.ramp_name || '';
                }, 500);
            }
            
            
            
            // Show/hide conditional fields
            toggleEditEventFields();
            
            // Handle poll fields (existing logic)
            setupPollFields(data.event_type, hasPoll, data.poll_closes_at);
            
            // Show the modal
            new bootstrap.Modal(document.getElementById('editEventModal')).show();
        })
        .catch(error => {
            console.error('Error fetching event data:', error);
            alert('Failed to load event data');
        });
}

function setupPollFields(eventType, hasPoll, pollClosesAt) {
    
    var pollClosesContainer = document.getElementById('edit_poll_closes_container');
    var pollClosesInput = document.getElementById('edit_poll_closes_date');
    
    if (eventType === 'sabc_tournament' && hasPoll) {
        pollClosesContainer.style.display = 'block';
        if (pollClosesAt) {
            // Convert ISO datetime to datetime-local format
            var date = new Date(pollClosesAt);
            var year = date.getFullYear();
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            var hours = String(date.getHours()).padStart(2, '0');
            var minutes = String(date.getMinutes()).padStart(2, '0');
            pollClosesInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }
    } else {
        pollClosesContainer.style.display = 'none';
        pollClosesInput.value = '';
    }
}

function fetchPollClosesDate(eventId, inputElement) {
    fetch(`/admin/events/${eventId}/poll-info`)
        .then(response => response.json())
        .then(data => {
            if (data.closes_at) {
                // Convert ISO datetime to datetime-local format (YYYY-MM-DDTHH:MM)
                var date = new Date(data.closes_at);
                var year = date.getFullYear();
                var month = String(date.getMonth() + 1).padStart(2, '0');
                var day = String(date.getDate()).padStart(2, '0');
                var hours = String(date.getHours()).padStart(2, '0');
                var minutes = String(date.getMinutes()).padStart(2, '0');
                
                inputElement.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
        })
        .catch(error => {
            console.error('Error fetching poll data:', error);
        });
}

function deleteEvent(id, hasDependencies, eventName = 'Event') {
    // Set the event name in the modal
    document.getElementById('delete-current-event-name').textContent = eventName;
    document.getElementById('delete-current-event-id').value = id;

    // Show/hide dependencies warning
    var warningElement = document.getElementById('delete-current-dependencies-warning');
    if (hasDependencies) {
        warningElement.style.display = 'block';
    } else {
        warningElement.style.display = 'none';
    }

    // Clear the confirmation input
    document.getElementById('delete-current-confirmation').value = '';

    // Show the modal
    var modal = new bootstrap.Modal(document.getElementById('deleteEventModal'));
    modal.show();
}

function confirmDeleteCurrentEvent() {
    var confirmText = document.getElementById('delete-current-confirmation').value;
    var eventId = document.getElementById('delete-current-event-id').value;

    if (confirmText.trim() !== 'DELETE') {
        alert('Please type DELETE to confirm');
        return;
    }

    // Close the modal
    bootstrap.Modal.getInstance(document.getElementById('deleteEventModal')).hide();

    // Delete the event
    fetch(`/admin/events/${eventId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else if (response.status === 400) {
            return response.json().then(data => {
                alert(data.error || 'Cannot delete event with dependencies.');
            });
        } else {
            alert('Error deleting event');
        }
    })
    .catch(error => {
        alert('Network error deleting event: ' + error.message);
    });
}

function deletePastEvent(id, name, hasDependencies) {
    // Set the event name in the modal
    document.getElementById('delete-event-name').textContent = name;
    document.getElementById('delete-event-id').value = id;
    
    // Show/hide dependencies warning
    var warningElement = document.getElementById('delete-dependencies-warning');
    if (hasDependencies) {
        warningElement.style.display = 'block';
    } else {
        warningElement.style.display = 'none';
    }
    
    // Clear the confirmation input
    document.getElementById('delete-confirmation').value = '';
    
    // Show the modal
    var modal = new bootstrap.Modal(document.getElementById('deletePastEventModal'));
    modal.show();
}

function confirmDeletePastEvent() {
    var confirmText = document.getElementById('delete-confirmation').value;
    var eventId = document.getElementById('delete-event-id').value;
    
    if (confirmText.trim() !== 'DELETE') {
        alert('Please type DELETE to confirm');
        return;
    }
    
    // Close the modal
    bootstrap.Modal.getInstance(document.getElementById('deletePastEventModal')).hide();
    
    // Delete the event
    fetch(`/admin/events/${eventId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            // Try to get the error message from the response
            return response.json().then(data => {
                if (response.status === 400) {
                    alert('Cannot delete event: ' + (data.error || 'Event has dependencies'));
                } else {
                    alert('Error deleting event: ' + (data.error || 'Server error'));
                }
            }).catch(() => {
                // If JSON parsing fails, show generic error
                alert('Error deleting event (status: ' + response.status + ')');
            });
        }
    })
    .catch(error => {
        alert('Network error deleting event: ' + error.message);
    });
}

// Event type conditional fields for create form
function toggleEventFields() {
    const eventType = document.getElementById('event_type').value;
    const sabcTournamentFields = document.getElementById('sabc-tournament-fields');
    const otherTournamentFields = document.getElementById('other-tournament-fields');
    const otherTournamentDescription = document.getElementById('other-tournament-description');
    const clubEventFields = document.getElementById('club-event-fields');
    const otherFields = document.getElementById('other-fields');
    const sabcFields = document.getElementById('sabc-fields');
    const holidayFields = document.getElementById('holiday-fields');

    // Hide all conditional fields first
    sabcTournamentFields.style.display = 'none';
    otherTournamentFields.style.display = 'none';
    otherTournamentDescription.style.display = 'none';
    clubEventFields.style.display = 'none';
    otherFields.style.display = 'none';
    sabcFields.style.display = 'none';
    holidayFields.style.display = 'none';

    // Clear fields and manage name attributes to prevent conflicts
    document.getElementById('start_time').value = '';
    document.getElementById('weigh_in_time').value = '';
    document.getElementById('other_start_time').value = '';
    document.getElementById('other_weigh_in_time').value = '';

    // Only clear and manage name attributes for non-active description fields
    // DO NOT clear the main description field value as it may contain user input
    if (document.getElementById('other_description')) {
        document.getElementById('other_description').value = '';
        document.getElementById('other_description').removeAttribute('name');
    }
    if (document.getElementById('club_description')) {
        document.getElementById('club_description').value = '';
        document.getElementById('club_description').removeAttribute('name');
        document.getElementById('club_description').removeAttribute('required');
    }

    // Show relevant fields based on event type and set active description field
    if (eventType === 'sabc_tournament') {
        sabcTournamentFields.style.display = 'flex';
        // Set default times for SABC tournaments
        document.getElementById('start_time').value = '06:00';
        document.getElementById('weigh_in_time').value = '15:00';
        // Main description field is already active with name="description"
    } else if (eventType === 'other_tournament') {
        otherTournamentFields.style.display = 'flex';
        otherTournamentDescription.style.display = 'flex';
        // Activate the other description field
        if (document.getElementById('other_description')) {
            document.getElementById('other_description').setAttribute('name', 'description');
        }
        // Load lakes for other tournament lake dropdown
        loadLakesForOtherTournament();
    } else if (eventType === 'club_event') {
        clubEventFields.style.display = 'flex';
        // Activate the club description field
        if (document.getElementById('club_description')) {
            document.getElementById('club_description').setAttribute('name', 'description');
            document.getElementById('club_description').setAttribute('required', 'required');
        }
    } else if (eventType === 'holiday') {
        otherFields.style.display = 'flex';
        holidayFields.style.display = 'flex';
        // Main description field is already active with name="description"
    } else {
        otherFields.style.display = 'flex';
        // Main description field is already active with name="description"
    }

    // Update form validation
    updateFieldRequirements(eventType);
}

// Event type conditional fields for edit modal
function toggleEditEventFields() {
    const eventType = document.getElementById('edit_event_type').value;
    const tournamentFields = document.getElementById('edit-tournament-fields');
    const sabcFields = document.getElementById('edit-sabc-fields');
    const holidayFields = document.getElementById('edit-holiday-fields');
    const pollClosesContainer = document.getElementById('edit_poll_closes_container');
    
    // Hide all conditional fields first
    tournamentFields.style.display = 'none';
    sabcFields.style.display = 'none';
    holidayFields.style.display = 'none';
    
    // Show relevant fields based on event type
    if (eventType === 'sabc_tournament') {
        tournamentFields.style.display = 'block';
        sabcFields.style.display = 'block';
    } else if (eventType === 'other_tournament' || eventType === 'club_event') {
        tournamentFields.style.display = 'block';
    } else if (eventType === 'holiday') {
        holidayFields.style.display = 'block';
        // Hide poll field for holidays
        if (pollClosesContainer) {
            pollClosesContainer.style.display = 'none';
        }
    }
}

function updateFieldRequirements(eventType) {
    const startTime = document.getElementById('start_time');
    const weighInTime = document.getElementById('weigh_in_time');
    const entryFee = document.getElementById('entry_fee');
    const lakeName = document.getElementById('lake_name');
    const rampName = document.getElementById('ramp_name');
    const otherStartTime = document.getElementById('other_start_time');
    const otherWeighInTime = document.getElementById('other_weigh_in_time');
    const otherLakeName = document.getElementById('other_lake_name');
    const clubDescription = document.getElementById('club_description');

    // Clear all requirements first
    [startTime, weighInTime, entryFee, lakeName, rampName, otherStartTime, otherWeighInTime, otherLakeName, clubDescription].forEach(field => {
        if (field) field.required = false;
    });

    // Set requirements based on event type
    if (eventType === 'sabc_tournament') {
        startTime.required = true;
        weighInTime.required = true;
        lakeName.required = true;
        rampName.required = true;
        // Entry fee has default value, not strictly required
    } else if (eventType === 'club_event') {
        clubDescription.required = true;
    }
    // For other tournaments, only event date, type, and name are required (handled in HTML)
    // Start/weigh-in times, lake, and ramp are all optional
}

// Load lakes for other tournament dropdown
function loadLakesForOtherTournament() {
    const otherLakeSelect = document.getElementById('other_lake_name');
    if (otherLakeSelect && lakesData.length > 0) {
        otherLakeSelect.innerHTML = '<option value="">-- Select Lake --</option>';
        lakesData.forEach(lake => {
            const option = document.createElement('option');
            option.value = lake.name;
            option.textContent = lake.name;
            option.dataset.lakeKey = lake.key;
            otherLakeSelect.appendChild(option);
        });
    }
}


// Real-time form validation
function validateEventForm() {
    const formData = {
        date: document.getElementById('date').value,
        name: document.getElementById('name').value,
        event_type: document.getElementById('event_type').value,
        start_time: document.getElementById('start_time').value,
        weigh_in_time: document.getElementById('weigh_in_time').value,
        entry_fee: document.getElementById('entry_fee').value
    };
    
    fetch('/admin/events/validate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        let message = 'Validation Results:\n\n';
        
        if (data.valid) {
            message += ' All validations passed!\n';
        } else {
            message += ' Errors found:\n';
            data.errors.forEach(error => {
                message += `   ${error}\n`;
            });
        }
        
        if (data.warnings.length > 0) {
            message += '\n  Warnings:\n';
            data.warnings.forEach(warning => {
                message += `   ${warning}\n`;
            });
        }
        
        alert(message);
    })
    .catch(error => {
        console.error('Validation error:', error);
        alert('Validation failed: ' + error.message);
    });
}

// Initialize event type handling
document.addEventListener('DOMContentLoaded', function() {
    // Load lakes on page load
    loadLakes();
    
    // Set up create form event type change handler
    document.getElementById('event_type').addEventListener('change', toggleEventFields);
    
    // Set up edit form event type change handler
    document.getElementById('edit_event_type').addEventListener('change', toggleEditEventFields);
    
    // Set up lake change handler for dynamic ramp loading (create form)
    document.getElementById('lake_name').addEventListener('change', function() {
        loadRamps(this.value, 'ramp_name');
    });

    // Set up lake change handler for other tournament lake dropdown
    document.getElementById('other_lake_name').addEventListener('change', function() {
        loadRamps(this.value, 'other_ramp_name');
    });
    
    // Set up lake change handler for dynamic ramp loading (edit form)
    document.getElementById('edit_lake_name').addEventListener('change', function() {
        loadRamps(this.value, 'edit_ramp_name');
    });
    
    // Initialize with default state
    toggleEventFields();
    
    // Auto-populate tournament name based on date
    document.getElementById('date').addEventListener('change', function() {
        const dateInput = this;
        const nameInput = document.getElementById('name');
        const eventType = document.getElementById('event_type').value;
        
        if (eventType === 'sabc_tournament' && dateInput.value && !nameInput.value) {
            const date = new Date(dateInput.value);
            const month = date.toLocaleString('default', { month: 'long' });
            const year = date.getFullYear();
            nameInput.value = `${month} ${year} Tournament`;
        }
    });
    
    // Initialize edit event listeners (existing code)
    document.querySelectorAll('.edit-event-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            var eventId = this.getAttribute('data-event-id');
            var eventDate = this.getAttribute('data-event-date');
            var eventType = this.getAttribute('data-event-type');
            var eventName = this.getAttribute('data-event-name');
            var eventDescription = this.getAttribute('data-event-description');
            var hasPoll = this.getAttribute('data-has-poll') === 'true';
            var pollActive = this.getAttribute('data-poll-active') === 'true';
            
            editEvent(eventId, eventDate, eventType, eventName, eventDescription, hasPoll, pollActive);
        });
    });
    
    // Initialize past event delete listeners (existing code)
    document.querySelectorAll('.delete-past-event').forEach(function(button) {
        button.addEventListener('click', function() {
            var eventId = this.getAttribute('data-event-id');
            var eventName = this.getAttribute('data-event-name');
            var hasDeps = this.getAttribute('data-has-deps') === 'true';
            
            deletePastEvent(eventId, eventName, hasDeps);
        });
    });
});

// Search and Filter Functions
function filterEvents(tabType) {
    const searchTerm = document.getElementById(`${tabType}-search`).value.toLowerCase();
    const yearFilter = document.getElementById(`${tabType}-year-filter`)?.value || '';
    const statusFilter = document.getElementById(`${tabType}-status-filter`)?.value || '';
    const lakeFilter = document.getElementById(`${tabType}-lake-filter`)?.value || '';
    const typeFilter = document.getElementById(`${tabType}-type-filter`)?.value || '';
    const resultsFilter = document.getElementById(`${tabType}-results-filter`)?.value || '';
    
    let tableSelector;
    if (tabType === 'past') {
        tableSelector = '#past-events-tab table tbody tr';
    } else {
        tableSelector = `#${tabType}-events table tbody tr`;
    }
    
    const rows = document.querySelectorAll(tableSelector);
    let visibleCount = 0;
    
    rows.forEach(row => {
        // Skip empty state rows
        if (row.cells.length <= 2 || row.textContent.includes('No events')) {
            return;
        }
        
        let visible = true;
        const rowText = row.textContent.toLowerCase();
        
        // Search term filter
        if (searchTerm && !rowText.includes(searchTerm)) {
            visible = false;
        }
        
        // Year filter
        if (yearFilter && !rowText.includes(yearFilter)) {
            visible = false;
        }
        
        // Status filter for tournaments
        if (statusFilter) {
            if (statusFilter === 'complete' && !rowText.includes('complete')) {
                visible = false;
            } else if (statusFilter === 'upcoming' && !rowText.includes('upcoming')) {
                visible = false;
            } else if (statusFilter === 'no-poll' && !rowText.includes('create poll')) {
                visible = false;
            } else if (statusFilter === 'poll-active' && !rowText.includes('active')) {
                visible = false;
            }
        }
        
        // Lake filter (basic text matching)
        if (lakeFilter) {
            const lakeName = lakeFilter.charAt(0).toUpperCase() + lakeFilter.slice(1);
            if (!rowText.includes(lakeName.toLowerCase())) {
                visible = false;
            }
        }
        
        // Type filter
        if (typeFilter) {
            if (typeFilter === 'sabc_tournament' && !row.innerHTML.includes('bi-trophy')) {
                visible = false;
            } else if (typeFilter === 'federal_holiday' && !row.innerHTML.includes('bi-calendar-heart')) {
                visible = false;
            } else if (typeFilter === 'other_tournament' && !row.innerHTML.includes('bi-calendar')) {
                visible = false;
            } else if (typeFilter === 'club_event' && !row.innerHTML.includes('bi-calendar-event')) {
                visible = false;
            }
        }
        
        // Results filter for past events
        if (resultsFilter) {
            if (resultsFilter === 'has-results' && !rowText.includes('yes')) {
                visible = false;
            } else if (resultsFilter === 'no-results' && rowText.includes('yes')) {
                visible = false;
            }
        }
        
        row.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
    });
    
    // Update empty state
    updateEmptyState(tabType, visibleCount);
}

function clearFilters(tabType) {
    // Clear all filter inputs for this tab
    document.getElementById(`${tabType}-search`).value = '';
    
    const yearFilter = document.getElementById(`${tabType}-year-filter`);
    if (yearFilter) yearFilter.value = '';
    
    const statusFilter = document.getElementById(`${tabType}-status-filter`);
    if (statusFilter) statusFilter.value = '';
    
    const lakeFilter = document.getElementById(`${tabType}-lake-filter`);
    if (lakeFilter) lakeFilter.value = '';
    
    const typeFilter = document.getElementById(`${tabType}-type-filter`);
    if (typeFilter) typeFilter.value = '';
    
    const resultsFilter = document.getElementById(`${tabType}-results-filter`);
    if (resultsFilter) resultsFilter.value = '';
    
    // Show all rows
    let tableSelector;
    if (tabType === 'past') {
        tableSelector = '#past-events-tab table tbody tr';
    } else {
        tableSelector = `#${tabType}-events table tbody tr`;
    }
    
    const rows = document.querySelectorAll(tableSelector);
    let visibleCount = 0;
    
    rows.forEach(row => {
        if (row.cells.length > 2 && !row.textContent.includes('No events')) {
            row.style.display = '';
            visibleCount++;
        }
    });
    
    updateEmptyState(tabType, visibleCount);
}

function updateEmptyState(tabType, visibleCount) {
    // Update tab badges with filtered counts
    const tabBadge = document.getElementById(`${tabType === 'sabc' ? 'sabc' : tabType === 'holidays' ? 'holidays' : tabType === 'other' ? 'other' : 'past'}-count`);
    
    if (tabBadge && visibleCount !== undefined) {
        // Store original count if not already stored
        if (!tabBadge.dataset.originalCount) {
            tabBadge.dataset.originalCount = tabBadge.textContent;
        }
        
        // Show filtered count if different from original
        if (document.getElementById(`${tabType}-search`).value || 
            document.getElementById(`${tabType}-year-filter`)?.value ||
            document.getElementById(`${tabType}-status-filter`)?.value ||
            document.getElementById(`${tabType}-lake-filter`)?.value ||
            document.getElementById(`${tabType}-type-filter`)?.value ||
            document.getElementById(`${tabType}-results-filter`)?.value) {
            tabBadge.textContent = visibleCount;
            tabBadge.classList.add('bg-warning');
            tabBadge.classList.remove('bg-primary', 'bg-info', 'bg-secondary');
        } else {
            tabBadge.textContent = tabBadge.dataset.originalCount;
            tabBadge.classList.remove('bg-warning');
            // Restore original badge color based on tab
            if (tabType === 'sabc') tabBadge.classList.add('bg-primary');
            else if (tabType === 'holidays') tabBadge.classList.add('bg-info');
            else if (tabType === 'other') tabBadge.classList.add('bg-warning');
            else tabBadge.classList.add('bg-secondary');
        }
    }
}

</script>
{% endblock %}