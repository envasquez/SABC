{% extends "base.html" %}

{% block title %}Manage Events - South Austin Bass Club{% endblock %}

{% block content %}
<div class="container">
    <div class="mb-4">
        <h1 class="display-5">
            <i class="bi bi-calendar3 me-2"></i>Event Management
        </h1>
        <p class="lead text-muted">Create and manage tournament events</p>
    </div>

    <!-- Add Event Form -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-plus-circle me-2"></i>Add New Event
            </h5>
        </div>
        <div class="card-body">
            {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
            {% endif %}
            
            <form method="POST" action="/admin/events/create">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="date" class="form-label">Event Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="date" name="date" required>
                    </div>
                    <div class="col-md-3">
                        <label for="event_type" class="form-label">Event Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="event_type" name="event_type" required>
                            <option value="sabc_tournament">SABC Tournament</option>
                            <option value="federal_holiday">Federal Holiday</option>
                            <option value="other_tournament">Other Tournament</option>
                            <option value="club_event">Club Event</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="name" class="form-label">Event Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" 
                               placeholder="e.g., August Tournament" required>
                    </div>
                    <div class="col-md-3">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="description" name="description" 
                               placeholder="e.g., Lake Travis - Main Basin">
                    </div>
                </div>
                
                <!-- Tournament-specific fields -->
                <div id="tournament-fields" class="row g-3 mt-2" style="display: none;">
                    <div class="col-md-2">
                        <label for="start_time" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="start_time" name="start_time" value="06:00">
                    </div>
                    <div class="col-md-2">
                        <label for="weigh_in_time" class="form-label">Weigh-in Time</label>
                        <input type="time" class="form-control" id="weigh_in_time" name="weigh_in_time" value="15:00">
                    </div>
                    <div class="col-md-2">
                        <label for="entry_fee" class="form-label">Entry Fee</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="entry_fee" name="entry_fee" value="25.00" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="lake_name" class="form-label">Lake</label>
                        <input type="text" class="form-control" id="lake_name" name="lake_name" placeholder="e.g., Lake Travis">
                    </div>
                    <div class="col-md-3">
                        <label for="ramp_name" class="form-label">Ramp</label>
                        <input type="text" class="form-control" id="ramp_name" name="ramp_name" placeholder="e.g., Mansfield Dam">
                    </div>
                </div>
                
                <!-- Holiday-specific fields -->
                <div id="holiday-fields" class="row g-3 mt-2" style="display: none;">
                    <div class="col-md-6">
                        <label for="holiday_name" class="form-label">Holiday Name</label>
                        <input type="text" class="form-control" id="holiday_name" name="holiday_name" placeholder="e.g., Independence Day">
                    </div>
                    <div class="col-md-6">
                        <div class="mt-4">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="populateHolidayFromDate()">
                                <i class="bi bi-magic me-1"></i>Auto-fill from date
                            </button>
                            <br><small class="form-text text-muted">Automatically populate holiday name based on selected date</small>
                        </div>
                    </div>
                </div>
                
                <!-- General event options -->
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_cancelled" name="is_cancelled">
                            <label class="form-check-label" for="is_cancelled">
                                Mark as cancelled
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Add Event
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="validateEventForm()">
                            <i class="bi bi-check-circle me-1"></i>Validate
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Tabs -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark p-0">
            <ul class="nav nav-tabs nav-fill" id="eventTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active text-light" id="sabc-tab" data-bs-toggle="tab" data-bs-target="#sabc-events" type="button" role="tab" aria-controls="sabc-events" aria-selected="true">
                        <i class="bi bi-trophy me-2"></i>SABC Tournaments
                        <span class="badge bg-primary ms-2" id="sabc-count">{{ events|selectattr('event_type', 'equalto', 'sabc_tournament')|list|length }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link text-light" id="holidays-tab" data-bs-toggle="tab" data-bs-target="#holidays-events" type="button" role="tab" aria-controls="holidays-events" aria-selected="false">
                        <i class="bi bi-calendar-heart me-2"></i>Federal Holidays
                        <span class="badge bg-info ms-2" id="holidays-count">{{ events|selectattr('event_type', 'equalto', 'federal_holiday')|list|length }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link text-light" id="other-tab" data-bs-toggle="tab" data-bs-target="#other-events" type="button" role="tab" aria-controls="other-events" aria-selected="false">
                        <i class="bi bi-calendar-plus me-2"></i>Other Events
                        <span class="badge bg-warning ms-2" id="other-count">{{ events|selectattr('event_type', 'in', ['other_tournament', 'club_event'])|list|length }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link text-light" id="past-tab" data-bs-toggle="tab" data-bs-target="#past-events-tab" type="button" role="tab" aria-controls="past-events-tab" aria-selected="false">
                        <i class="bi bi-calendar-x me-2"></i>Past Events
                        <span class="badge bg-secondary ms-2" id="past-count">{{ total_past }}</span>
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body p-0">
            <div class="tab-content" id="eventTabsContent">
                
                <!-- SABC Tournaments Tab -->
                <div class="tab-pane fade show active" id="sabc-events" role="tabpanel" aria-labelledby="sabc-tab">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-secondary text-white border-bottom">
                        <h6 class="mb-0"><i class="bi bi-trophy me-2 text-primary"></i>SABC Tournament Management</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="showBulkCreateTournaments()">
                                <i class="bi bi-calendar-plus me-1"></i>Create Year
                            </button>
                            <button class="btn btn-outline-danger" onclick="showBulkDelete('sabc_tournament')">
                                <i class="bi bi-trash me-1"></i>Bulk Delete
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search and Filter for SABC -->
                    <div class="p-3 border-bottom bg-dark">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="sabc-search" placeholder="Search tournaments..." onkeyup="filterEvents('sabc')">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="sabc-year-filter" onchange="filterEvents('sabc')">
                                    <option value="">All Years</option>
                                    {% for year in range(2023, 2027) %}
                                    <option value="{{ year }}" {% if year == 2025 %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="sabc-status-filter" onchange="filterEvents('sabc')">
                                    <option value="">All Status</option>
                                    <option value="complete">Complete</option>
                                    <option value="upcoming">Upcoming</option>
                                    <option value="no-poll">No Poll</option>
                                    <option value="poll-active">Poll Active</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="sabc-lake-filter" onchange="filterEvents('sabc')">
                                    <option value="">All Lakes</option>
                                    <option value="travis">Lake Travis</option>
                                    <option value="austin">Lake Austin</option>
                                    <option value="bastrop">Lake Bastrop</option>
                                    <option value="buchanan">Lake Buchanan</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters('sabc')">
                                    <i class="bi bi-x-circle me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% set sabc_events = events|selectattr('event_type', 'equalto', 'sabc_tournament')|list %}
                    {% include 'admin/events_table.html' with context %}
                </div>

                <!-- Federal Holidays Tab -->
                <div class="tab-pane fade" id="holidays-events" role="tabpanel" aria-labelledby="holidays-tab">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-secondary text-white border-bottom">
                        <h6 class="mb-0"><i class="bi bi-calendar-heart me-2 text-info"></i>Federal Holiday Calendar</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="showBulkCreateHolidays()">
                                <i class="bi bi-calendar-plus me-1"></i>Add Year
                            </button>
                            <button class="btn btn-outline-danger" onclick="showBulkDelete('federal_holiday')">
                                <i class="bi bi-trash me-1"></i>Bulk Delete
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search and Filter for Holidays -->
                    <div class="p-3 border-bottom bg-dark">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="holidays-search" placeholder="Search holidays..." onkeyup="filterEvents('holidays')">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="holidays-year-filter" onchange="filterEvents('holidays')">
                                    <option value="">All Years</option>
                                    {% for year in range(2023, 2027) %}
                                    <option value="{{ year }}" {% if year == 2025 %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters('holidays')">
                                    <i class="bi bi-x-circle me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% set sabc_events = events|selectattr('event_type', 'equalto', 'federal_holiday')|list %}
                    {% include 'admin/events_table.html' with context %}
                </div>

                <!-- Other Events Tab -->
                <div class="tab-pane fade" id="other-events" role="tabpanel" aria-labelledby="other-tab">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-secondary text-white border-bottom">
                        <h6 class="mb-0"><i class="bi bi-calendar-plus me-2 text-warning"></i>Other Events & Tournaments</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-danger" onclick="showBulkDelete('other')">
                                <i class="bi bi-trash me-1"></i>Bulk Delete
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search and Filter for Other Events -->
                    <div class="p-3 border-bottom bg-dark">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="other-search" placeholder="Search events..." onkeyup="filterEvents('other')">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="other-year-filter" onchange="filterEvents('other')">
                                    <option value="">All Years</option>
                                    {% for year in range(2023, 2027) %}
                                    <option value="{{ year }}" {% if year == 2025 %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="other-type-filter" onchange="filterEvents('other')">
                                    <option value="">All Types</option>
                                    <option value="other_tournament">Other Tournaments</option>
                                    <option value="club_event">Club Events</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters('other')">
                                    <i class="bi bi-x-circle me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% set sabc_events = events|selectattr('event_type', 'in', ['other_tournament', 'club_event'])|list %}
                    {% include 'admin/events_table.html' with context %}
                </div>

                <!-- Past Events Tab -->
                <div class="tab-pane fade" id="past-events-tab" role="tabpanel" aria-labelledby="past-tab">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-secondary text-white border-bottom">
                        <h6 class="mb-0"><i class="bi bi-calendar-x me-2"></i>Past Events Archive</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-danger" onclick="showBulkDelete('past')">
                                <i class="bi bi-trash me-1"></i>Bulk Delete
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search and Filter for Past Events -->
                    <div class="p-3 border-bottom bg-dark">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="past-search" placeholder="Search past events..." onkeyup="filterEvents('past')">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="past-year-filter" onchange="filterEvents('past')">
                                    <option value="">All Years</option>
                                    {% for year in range(2020, 2025) %}
                                    <option value="{{ year }}">{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="past-type-filter" onchange="filterEvents('past')">
                                    <option value="">All Types</option>
                                    <option value="sabc_tournament">SABC</option>
                                    <option value="federal_holiday">Holidays</option>
                                    <option value="other_tournament">Other Tournaments</option>
                                    <option value="club_event">Club Events</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="past-results-filter" onchange="filterEvents('past')">
                                    <option value="">All Results</option>
                                    <option value="has-results">Has Results</option>
                                    <option value="no-results">No Results</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters('past')">
                                    <i class="bi bi-x-circle me-1"></i>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% include 'admin/past_events_table.html' with context %}
                </div>

            </div>
        </div>
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/admin/events/edit" id="editEventForm">
                <div class="modal-body">
                    <input type="hidden" id="edit_event_id" name="event_id">
                    <div class="mb-3">
                        <label for="edit_date" class="form-label">Event Date</label>
                        <input type="date" class="form-control" id="edit_date" name="date" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_event_type" class="form-label">Event Type</label>
                        <select class="form-select" id="edit_event_type" name="event_type" required>
                            <option value="sabc_tournament">SABC Tournament</option>
                            <option value="federal_holiday">Federal Holiday</option>
                            <option value="other_tournament">Other Tournament</option>
                            <option value="club_event">Club Event</option>
                        </select>
                    </div>
                    <div class="mb-3" id="edit_poll_closes_container" style="display: none;">
                        <label for="edit_poll_closes_date" class="form-label">Poll Closes Date & Time</label>
                        <input type="datetime-local" class="form-control" id="edit_poll_closes_date" name="poll_closes_date" 
                               title="Date and time when tournament location poll closes">
                        <div class="form-text">Only shown for SABC tournaments with existing polls</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Event Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="edit_description" name="description">
                    </div>
                    
                    <!-- Tournament-specific fields -->
                    <div id="edit-tournament-fields" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="edit_start_time" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="edit_start_time" name="start_time">
                            </div>
                            <div class="col-md-6">
                                <label for="edit_weigh_in_time" class="form-label">Weigh-in Time</label>
                                <input type="time" class="form-control" id="edit_weigh_in_time" name="weigh_in_time">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="edit_entry_fee" class="form-label">Entry Fee</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="edit_entry_fee" name="entry_fee" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="edit_lake_name" class="form-label">Lake</label>
                                <input type="text" class="form-control" id="edit_lake_name" name="lake_name">
                            </div>
                            <div class="col-md-4">
                                <label for="edit_ramp_name" class="form-label">Ramp</label>
                                <input type="text" class="form-control" id="edit_ramp_name" name="ramp_name">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Holiday-specific fields -->
                    <div id="edit-holiday-fields" style="display: none;">
                        <div class="mb-3">
                            <label for="edit_holiday_name" class="form-label">Holiday Name</label>
                            <input type="text" class="form-control" id="edit_holiday_name" name="holiday_name">
                        </div>
                    </div>
                    
                    <!-- General options -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_is_cancelled" name="is_cancelled">
                            <label class="form-check-label" for="edit_is_cancelled">
                                Mark as cancelled
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Past Event Modal -->
<div class="modal fade" id="deletePastEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Delete Past Event</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Warning:</strong> You are about to delete a past event. This action cannot be undone.
                </div>
                <p>Event: <strong id="delete-event-name"></strong></p>
                <p id="delete-dependencies-warning" class="text-warning" style="display: none;">
                    <i class="bi bi-info-circle me-1"></i>This event has associated data that will also be removed:
                    <ul class="mt-2">
                        <li>Polls and poll votes (if any)</li>
                        <li>Tournament setup (if no results exist)</li>
                    </ul>
                </p>
                <p class="mt-3">To confirm deletion, please type <code>DELETE</code> in the field below:</p>
                <input type="text" class="form-control" id="delete-confirmation" placeholder="Type DELETE to confirm">
                <input type="hidden" id="delete-event-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeletePastEvent()">
                    <i class="bi bi-trash me-1"></i>Delete Event
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// This section is handled by the main DOMContentLoaded listener below

function editEvent(id, date, eventType, name, description, hasPoll, pollActive) {
    // Fetch complete event data
    fetch(`/admin/events/${id}/info`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error loading event data: ' + data.error);
                return;
            }
            
            // Populate basic fields
            document.getElementById('edit_event_id').value = data.id;
            document.getElementById('edit_date').value = data.date;
            document.getElementById('edit_event_type').value = data.event_type;
            document.getElementById('edit_name').value = data.name;
            document.getElementById('edit_description').value = data.description;
            
            // Populate tournament fields
            document.getElementById('edit_start_time').value = data.start_time || '06:00';
            document.getElementById('edit_weigh_in_time').value = data.weigh_in_time || '15:00';
            document.getElementById('edit_entry_fee').value = data.entry_fee || 25.00;
            document.getElementById('edit_lake_name').value = data.lake_name || '';
            document.getElementById('edit_ramp_name').value = data.ramp_name || '';
            
            // Populate holiday fields
            document.getElementById('edit_holiday_name').value = data.holiday_name || '';
            
            // Populate general fields
            document.getElementById('edit_is_cancelled').checked = data.is_cancelled;
            
            // Show/hide conditional fields
            toggleEditEventFields();
            
            // Handle poll fields (existing logic)
            setupPollFields(data.event_type, hasPoll, data.poll_closes_at);
            
            // Show the modal
            new bootstrap.Modal(document.getElementById('editEventModal')).show();
        })
        .catch(error => {
            console.error('Error fetching event data:', error);
            alert('Failed to load event data');
        });
}

function setupPollFields(eventType, hasPoll, pollClosesAt) {
    
    var pollClosesContainer = document.getElementById('edit_poll_closes_container');
    var pollClosesInput = document.getElementById('edit_poll_closes_date');
    
    if (eventType === 'sabc_tournament' && hasPoll) {
        pollClosesContainer.style.display = 'block';
        if (pollClosesAt) {
            // Convert ISO datetime to datetime-local format
            var date = new Date(pollClosesAt);
            var year = date.getFullYear();
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            var hours = String(date.getHours()).padStart(2, '0');
            var minutes = String(date.getMinutes()).padStart(2, '0');
            pollClosesInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }
    } else {
        pollClosesContainer.style.display = 'none';
        pollClosesInput.value = '';
    }
}

function fetchPollClosesDate(eventId, inputElement) {
    fetch(`/admin/events/${eventId}/poll-info`)
        .then(response => response.json())
        .then(data => {
            if (data.closes_at) {
                // Convert ISO datetime to datetime-local format (YYYY-MM-DDTHH:MM)
                var date = new Date(data.closes_at);
                var year = date.getFullYear();
                var month = String(date.getMonth() + 1).padStart(2, '0');
                var day = String(date.getDate()).padStart(2, '0');
                var hours = String(date.getHours()).padStart(2, '0');
                var minutes = String(date.getMinutes()).padStart(2, '0');
                
                inputElement.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
        })
        .catch(error => {
            console.error('Error fetching poll data:', error);
        });
}

function deleteEvent(id, hasDependencies) {
    var message = hasDependencies 
        ? 'This event has associated polls or tournaments. Deleting it will also remove these. Are you sure?' 
        : 'Are you sure you want to delete this event?';
    
    if (confirm(message)) {
        fetch(`/admin/events/${id}`, { 
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else if (response.status === 400) {
                return response.json().then(data => {
                    alert(data.error || 'Cannot delete event with dependencies.');
                });
            } else {
                alert('Error deleting event');
            }
        });
    }
}

function deletePastEvent(id, name, hasDependencies) {
    // Set the event name in the modal
    document.getElementById('delete-event-name').textContent = name;
    document.getElementById('delete-event-id').value = id;
    
    // Show/hide dependencies warning
    var warningElement = document.getElementById('delete-dependencies-warning');
    if (hasDependencies) {
        warningElement.style.display = 'block';
    } else {
        warningElement.style.display = 'none';
    }
    
    // Clear the confirmation input
    document.getElementById('delete-confirmation').value = '';
    
    // Show the modal
    var modal = new bootstrap.Modal(document.getElementById('deletePastEventModal'));
    modal.show();
}

function confirmDeletePastEvent() {
    var confirmText = document.getElementById('delete-confirmation').value;
    var eventId = document.getElementById('delete-event-id').value;
    
    if (confirmText.trim() !== 'DELETE') {
        alert('Please type DELETE to confirm');
        return;
    }
    
    // Close the modal
    bootstrap.Modal.getInstance(document.getElementById('deletePastEventModal')).hide();
    
    // Delete the event
    fetch(`/admin/events/${eventId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            // Try to get the error message from the response
            return response.json().then(data => {
                if (response.status === 400) {
                    alert('Cannot delete event: ' + (data.error || 'Event has dependencies'));
                } else {
                    alert('Error deleting event: ' + (data.error || 'Server error'));
                }
            }).catch(() => {
                // If JSON parsing fails, show generic error
                alert('Error deleting event (status: ' + response.status + ')');
            });
        }
    })
    .catch(error => {
        alert('Network error deleting event: ' + error.message);
    });
}

// Event type conditional fields for create form
function toggleEventFields() {
    const eventType = document.getElementById('event_type').value;
    const tournamentFields = document.getElementById('tournament-fields');
    const holidayFields = document.getElementById('holiday-fields');
    
    // Hide all conditional fields first
    tournamentFields.style.display = 'none';
    holidayFields.style.display = 'none';
    
    // Show relevant fields based on event type
    if (eventType === 'sabc_tournament' || eventType === 'other_tournament') {
        tournamentFields.style.display = 'flex';
    } else if (eventType === 'federal_holiday') {
        holidayFields.style.display = 'flex';
    }
    
    // Update form validation
    updateFieldRequirements(eventType);
}

// Event type conditional fields for edit modal
function toggleEditEventFields() {
    const eventType = document.getElementById('edit_event_type').value;
    const tournamentFields = document.getElementById('edit-tournament-fields');
    const holidayFields = document.getElementById('edit-holiday-fields');
    const pollClosesContainer = document.getElementById('edit_poll_closes_container');
    
    // Hide all conditional fields first
    tournamentFields.style.display = 'none';
    holidayFields.style.display = 'none';
    
    // Show relevant fields based on event type
    if (eventType === 'sabc_tournament' || eventType === 'other_tournament') {
        tournamentFields.style.display = 'block';
    } else if (eventType === 'federal_holiday') {
        holidayFields.style.display = 'block';
        // Hide poll field for holidays
        if (pollClosesContainer) {
            pollClosesContainer.style.display = 'none';
        }
    }
}

function updateFieldRequirements(eventType) {
    const startTime = document.getElementById('start_time');
    const weighInTime = document.getElementById('weigh_in_time');
    const entryFee = document.getElementById('entry_fee');
    const holidayName = document.getElementById('holiday_name');
    
    // Clear all requirements first
    [startTime, weighInTime, entryFee, holidayName].forEach(field => {
        field.required = false;
    });
    
    // Set requirements based on event type
    if (eventType === 'sabc_tournament') {
        startTime.required = true;
        weighInTime.required = true;
        entryFee.required = true;
    } else if (eventType === 'federal_holiday') {
        holidayName.required = true;
    }
}

// Auto-populate holiday name from date
function populateHolidayFromDate() {
    const dateInput = document.getElementById('date');
    const holidayNameInput = document.getElementById('holiday_name');
    
    if (!dateInput.value) {
        alert('Please select a date first');
        return;
    }
    
    const selectedDate = new Date(dateInput.value);
    const year = selectedDate.getFullYear();
    
    // Check common federal holidays
    const holidays = {
        [`${year}-01-01`]: "New Year's Day",
        [`${year}-07-04`]: "Independence Day",
        [`${year}-11-11`]: "Veterans Day",
        [`${year}-12-25`]: "Christmas Day"
    };
    
    const dateStr = dateInput.value;
    if (holidays[dateStr]) {
        holidayNameInput.value = holidays[dateStr];
    } else {
        // For floating holidays, make a simple API call
        fetch(`/admin/federal-holidays/${year}`)
            .then(response => response.json())
            .then(data => {
                const holiday = data.holidays.find(h => h[0] === dateStr);
                if (holiday) {
                    holidayNameInput.value = holiday[1];
                } else {
                    alert('No federal holiday found for this date');
                }
            })
            .catch(error => {
                console.error('Error fetching holidays:', error);
                alert('Could not fetch holiday information');
            });
    }
}

// Real-time form validation
function validateEventForm() {
    const formData = {
        date: document.getElementById('date').value,
        name: document.getElementById('name').value,
        event_type: document.getElementById('event_type').value,
        start_time: document.getElementById('start_time').value,
        weigh_in_time: document.getElementById('weigh_in_time').value,
        entry_fee: document.getElementById('entry_fee').value
    };
    
    fetch('/admin/events/validate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        let message = 'Validation Results:\n\n';
        
        if (data.valid) {
            message += '✅ All validations passed!\n';
        } else {
            message += '❌ Errors found:\n';
            data.errors.forEach(error => {
                message += `  • ${error}\n`;
            });
        }
        
        if (data.warnings.length > 0) {
            message += '\n⚠️  Warnings:\n';
            data.warnings.forEach(warning => {
                message += `  • ${warning}\n`;
            });
        }
        
        alert(message);
    })
    .catch(error => {
        console.error('Validation error:', error);
        alert('Validation failed: ' + error.message);
    });
}

// Initialize event type handling
document.addEventListener('DOMContentLoaded', function() {
    // Set up create form event type change handler
    document.getElementById('event_type').addEventListener('change', toggleEventFields);
    
    // Set up edit form event type change handler
    document.getElementById('edit_event_type').addEventListener('change', toggleEditEventFields);
    
    // Initialize with default state
    toggleEventFields();
    
    // Auto-populate tournament name based on date
    document.getElementById('date').addEventListener('change', function() {
        const dateInput = this;
        const nameInput = document.getElementById('name');
        const eventType = document.getElementById('event_type').value;
        
        if (eventType === 'sabc_tournament' && dateInput.value && !nameInput.value) {
            const date = new Date(dateInput.value);
            const month = date.toLocaleString('default', { month: 'long' });
            const year = date.getFullYear();
            nameInput.value = `${month} ${year} Tournament`;
        }
    });
    
    // Initialize edit event listeners (existing code)
    document.querySelectorAll('.edit-event-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            var eventId = this.getAttribute('data-event-id');
            var eventDate = this.getAttribute('data-event-date');
            var eventType = this.getAttribute('data-event-type');
            var eventName = this.getAttribute('data-event-name');
            var eventDescription = this.getAttribute('data-event-description');
            var hasPoll = this.getAttribute('data-has-poll') === 'true';
            var pollActive = this.getAttribute('data-poll-active') === 'true';
            
            editEvent(eventId, eventDate, eventType, eventName, eventDescription, hasPoll, pollActive);
        });
    });
    
    // Initialize past event delete listeners (existing code)
    document.querySelectorAll('.delete-past-event').forEach(function(button) {
        button.addEventListener('click', function() {
            var eventId = this.getAttribute('data-event-id');
            var eventName = this.getAttribute('data-event-name');
            var hasDeps = this.getAttribute('data-has-deps') === 'true';
            
            deletePastEvent(eventId, eventName, hasDeps);
        });
    });
});

// Search and Filter Functions
function filterEvents(tabType) {
    const searchTerm = document.getElementById(`${tabType}-search`).value.toLowerCase();
    const yearFilter = document.getElementById(`${tabType}-year-filter`)?.value || '';
    const statusFilter = document.getElementById(`${tabType}-status-filter`)?.value || '';
    const lakeFilter = document.getElementById(`${tabType}-lake-filter`)?.value || '';
    const typeFilter = document.getElementById(`${tabType}-type-filter`)?.value || '';
    const resultsFilter = document.getElementById(`${tabType}-results-filter`)?.value || '';
    
    let tableSelector;
    if (tabType === 'past') {
        tableSelector = '#past-events-tab table tbody tr';
    } else {
        tableSelector = `#${tabType}-events table tbody tr`;
    }
    
    const rows = document.querySelectorAll(tableSelector);
    let visibleCount = 0;
    
    rows.forEach(row => {
        // Skip empty state rows
        if (row.cells.length <= 2 || row.textContent.includes('No events')) {
            return;
        }
        
        let visible = true;
        const rowText = row.textContent.toLowerCase();
        
        // Search term filter
        if (searchTerm && !rowText.includes(searchTerm)) {
            visible = false;
        }
        
        // Year filter
        if (yearFilter && !rowText.includes(yearFilter)) {
            visible = false;
        }
        
        // Status filter for tournaments
        if (statusFilter) {
            if (statusFilter === 'complete' && !rowText.includes('complete')) {
                visible = false;
            } else if (statusFilter === 'upcoming' && !rowText.includes('upcoming')) {
                visible = false;
            } else if (statusFilter === 'no-poll' && !rowText.includes('create poll')) {
                visible = false;
            } else if (statusFilter === 'poll-active' && !rowText.includes('active')) {
                visible = false;
            }
        }
        
        // Lake filter (basic text matching)
        if (lakeFilter) {
            const lakeName = lakeFilter.charAt(0).toUpperCase() + lakeFilter.slice(1);
            if (!rowText.includes(lakeName.toLowerCase())) {
                visible = false;
            }
        }
        
        // Type filter
        if (typeFilter) {
            if (typeFilter === 'sabc_tournament' && !row.innerHTML.includes('bi-trophy')) {
                visible = false;
            } else if (typeFilter === 'federal_holiday' && !row.innerHTML.includes('bi-calendar-heart')) {
                visible = false;
            } else if (typeFilter === 'other_tournament' && !row.innerHTML.includes('bi-calendar')) {
                visible = false;
            } else if (typeFilter === 'club_event' && !row.innerHTML.includes('bi-calendar-event')) {
                visible = false;
            }
        }
        
        // Results filter for past events
        if (resultsFilter) {
            if (resultsFilter === 'has-results' && !rowText.includes('yes')) {
                visible = false;
            } else if (resultsFilter === 'no-results' && rowText.includes('yes')) {
                visible = false;
            }
        }
        
        row.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
    });
    
    // Update empty state
    updateEmptyState(tabType, visibleCount);
}

function clearFilters(tabType) {
    // Clear all filter inputs for this tab
    document.getElementById(`${tabType}-search`).value = '';
    
    const yearFilter = document.getElementById(`${tabType}-year-filter`);
    if (yearFilter) yearFilter.value = '';
    
    const statusFilter = document.getElementById(`${tabType}-status-filter`);
    if (statusFilter) statusFilter.value = '';
    
    const lakeFilter = document.getElementById(`${tabType}-lake-filter`);
    if (lakeFilter) lakeFilter.value = '';
    
    const typeFilter = document.getElementById(`${tabType}-type-filter`);
    if (typeFilter) typeFilter.value = '';
    
    const resultsFilter = document.getElementById(`${tabType}-results-filter`);
    if (resultsFilter) resultsFilter.value = '';
    
    // Show all rows
    let tableSelector;
    if (tabType === 'past') {
        tableSelector = '#past-events-tab table tbody tr';
    } else {
        tableSelector = `#${tabType}-events table tbody tr`;
    }
    
    const rows = document.querySelectorAll(tableSelector);
    let visibleCount = 0;
    
    rows.forEach(row => {
        if (row.cells.length > 2 && !row.textContent.includes('No events')) {
            row.style.display = '';
            visibleCount++;
        }
    });
    
    updateEmptyState(tabType, visibleCount);
}

function updateEmptyState(tabType, visibleCount) {
    // Update tab badges with filtered counts
    const tabBadge = document.getElementById(`${tabType === 'sabc' ? 'sabc' : tabType === 'holidays' ? 'holidays' : tabType === 'other' ? 'other' : 'past'}-count`);
    
    if (tabBadge && visibleCount !== undefined) {
        // Store original count if not already stored
        if (!tabBadge.dataset.originalCount) {
            tabBadge.dataset.originalCount = tabBadge.textContent;
        }
        
        // Show filtered count if different from original
        if (document.getElementById(`${tabType}-search`).value || 
            document.getElementById(`${tabType}-year-filter`)?.value ||
            document.getElementById(`${tabType}-status-filter`)?.value ||
            document.getElementById(`${tabType}-lake-filter`)?.value ||
            document.getElementById(`${tabType}-type-filter`)?.value ||
            document.getElementById(`${tabType}-results-filter`)?.value) {
            tabBadge.textContent = visibleCount;
            tabBadge.classList.add('bg-warning');
            tabBadge.classList.remove('bg-primary', 'bg-info', 'bg-secondary');
        } else {
            tabBadge.textContent = tabBadge.dataset.originalCount;
            tabBadge.classList.remove('bg-warning');
            // Restore original badge color based on tab
            if (tabType === 'sabc') tabBadge.classList.add('bg-primary');
            else if (tabType === 'holidays') tabBadge.classList.add('bg-info');
            else if (tabType === 'other') tabBadge.classList.add('bg-warning');
            else tabBadge.classList.add('bg-secondary');
        }
    }
}

</script>
{% endblock %}