{% extends "base.html" %}
{% from 'macros.html' import alert, csrf_token %}
{% block title %}Merge Duplicate Accounts - South Austin Bass Club{% endblock %}
{% block content %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="display-5 mb-0"><i class="bi bi-arrow-left-right me-2"></i>Merge Duplicate Accounts</h1>
            <p class="lead text-secondary mb-0">Consolidate duplicate user accounts into one</p>
        </div>
        <a href="/admin/users" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Users
        </a>
    </div>

    <!-- Warning Banner -->
    <div class="alert alert-warning border-warning">
        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Important Information</h5>
        <p class="mb-2">This tool merges duplicate accounts by:</p>
        <ul class="mb-2">
            <li>Moving all tournament results, poll votes, and officer positions from the source account to the target account</li>
            <li>Updating all created content (polls, news, tournaments) to show the target account as creator</li>
            <li>Deleting duplicate poll votes (where both accounts voted on the same poll)</li>
            <li>Keeping the source account for audit purposes (can be manually deleted after merge)</li>
        </ul>
        <p class="mb-0"><strong>This action cannot be easily undone. Review the preview carefully before proceeding.</strong></p>
    </div>
</div>

<!-- Account Selection -->
<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card bg-dark border-danger h-100">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-person-x me-2"></i>Source Account (Old)</h5>
                <small>Data will be moved FROM this account</small>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="source_id" class="form-label">Select Account to Merge From</label>
                    <select class="form-select form-select-lg" id="source_id" name="source_id">
                        <option value="">-- Select Source Account --</option>
                        {% for angler in anglers %}
                        <option value="{{ angler.id }}">
                            {{ angler.name }}
                            {% if angler.email %}({{ angler.email }}){% endif %}
                            - ID: {{ angler.id }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div id="source_details" class="d-none">
                    <hr>
                    <h6>Account Details</h6>
                    <div id="source_info"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-dark border-success h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-person-check me-2"></i>Target Account (New)</h5>
                <small>Data will be moved TO this account</small>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="target_id" class="form-label">Select Account to Merge To</label>
                    <select class="form-select form-select-lg" id="target_id" name="target_id">
                        <option value="">-- Select Target Account --</option>
                        {% for angler in anglers %}
                        <option value="{{ angler.id }}">
                            {{ angler.name }}
                            {% if angler.email %}({{ angler.email }}){% endif %}
                            - ID: {{ angler.id }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div id="target_details" class="d-none">
                    <hr>
                    <h6>Account Details</h6>
                    <div id="target_info"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Section (shown via HTMX) -->
<div id="preview_section" class="d-none">
    <div class="card bg-dark border-primary mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Merge Preview</h5>
        </div>
        <div class="card-body">
            <div id="preview_content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading preview...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading preview...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Section -->
    <div class="card bg-dark border-warning">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-shield-exclamation me-2"></i>Confirm Merge</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="/admin/users/merge/execute" id="merge_form">
                {{ csrf_token(request) }}
                <input type="hidden" name="source_id" id="form_source_id">
                <input type="hidden" name="target_id" id="form_target_id">

                <div class="alert alert-danger border-danger">
                    <h5 class="alert-heading"><i class="bi bi-exclamation-octagon-fill me-2"></i>Final Warning</h5>
                    <p class="mb-0">You are about to merge these accounts. This will permanently move all data from the source account to the target account. Duplicate poll votes will be deleted.</p>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirm_checkbox" name="confirm" value="true">
                    <label class="form-check-label" for="confirm_checkbox">
                        <strong>I understand this action cannot be undone and I have reviewed the preview above.</strong>
                    </label>
                </div>

                <button type="submit" class="btn btn-danger btn-lg w-100" id="execute_button" disabled>
                    <i class="bi bi-arrow-left-right me-2"></i>Execute Merge
                </button>
            </form>
        </div>
    </div>
</div>

<script src="/static/admin-merge-users.js"></script>
{% endblock %}
