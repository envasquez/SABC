{% extends "base.html" %}
{% from 'macros.html' import alert, csrf_token %}
{% block title %}Merge Duplicate Accounts - South Austin Bass Club{% endblock %}
{% block content %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="display-5 mb-0"><i class="bi bi-arrow-left-right me-2"></i>Merge Duplicate Accounts</h1>
            <p class="lead text-secondary mb-0">Consolidate duplicate user accounts into one</p>
        </div>
        <a href="/admin/users" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Users
        </a>
    </div>

    <!-- Warning Banner -->
    <div class="alert alert-warning border-warning">
        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Important Information</h5>
        <p class="mb-2">This tool merges duplicate accounts by:</p>
        <ul class="mb-2">
            <li>Moving all tournament results, poll votes, and officer positions from the source account to the target account</li>
            <li>Updating all created content (polls, news, tournaments) to show the target account as creator</li>
            <li>Deleting duplicate poll votes (where both accounts voted on the same poll)</li>
            <li>Keeping the source account for audit purposes (can be manually deleted after merge)</li>
        </ul>
        <p class="mb-0"><strong>This action cannot be easily undone. Review the preview carefully before proceeding.</strong></p>
    </div>
</div>

<!-- Account Selection -->
<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card bg-dark border-danger h-100">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-person-x me-2"></i>Source Account (Old)</h5>
                <small>Data will be moved FROM this account</small>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="source_id" class="form-label">Select Account to Merge From</label>
                    <select class="form-select form-select-lg" id="source_id" name="source_id">
                        <option value="">-- Select Source Account --</option>
                        {% for angler in anglers %}
                        <option value="{{ angler.id }}">
                            {{ angler.name }}
                            {% if angler.email %}({{ angler.email }}){% endif %}
                            - ID: {{ angler.id }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div id="source_details" class="d-none">
                    <hr>
                    <h6>Account Details</h6>
                    <div id="source_info"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-dark border-success h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-person-check me-2"></i>Target Account (New)</h5>
                <small>Data will be moved TO this account</small>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="target_id" class="form-label">Select Account to Merge To</label>
                    <select class="form-select form-select-lg" id="target_id" name="target_id">
                        <option value="">-- Select Target Account --</option>
                        {% for angler in anglers %}
                        <option value="{{ angler.id }}">
                            {{ angler.name }}
                            {% if angler.email %}({{ angler.email }}){% endif %}
                            - ID: {{ angler.id }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div id="target_details" class="d-none">
                    <hr>
                    <h6>Account Details</h6>
                    <div id="target_info"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Section (shown via HTMX) -->
<div id="preview_section" class="d-none">
    <div class="card bg-dark border-primary mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Merge Preview</h5>
        </div>
        <div class="card-body">
            <div id="preview_content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading preview...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading preview...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Section -->
    <div class="card bg-dark border-warning">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-shield-exclamation me-2"></i>Confirm Merge</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="/admin/users/merge/execute" id="merge_form">
                {{ csrf_token(request) }}
                <input type="hidden" name="source_id" id="form_source_id">
                <input type="hidden" name="target_id" id="form_target_id">

                <div class="alert alert-danger border-danger">
                    <h5 class="alert-heading"><i class="bi bi-exclamation-octagon-fill me-2"></i>Final Warning</h5>
                    <p class="mb-0">You are about to merge these accounts. This will permanently move all data from the source account to the target account. Duplicate poll votes will be deleted.</p>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirm_checkbox" name="confirm" value="true">
                    <label class="form-check-label" for="confirm_checkbox">
                        <strong>I understand this action cannot be undone and I have reviewed the preview above.</strong>
                    </label>
                </div>

                <button type="submit" class="btn btn-danger btn-lg w-100" id="execute_button" disabled>
                    <i class="bi bi-arrow-left-right me-2"></i>Execute Merge
                </button>
            </form>
        </div>
    </div>
</div>

<script>
// Enable/disable execute button based on checkbox
document.getElementById('confirm_checkbox').addEventListener('change', function() {
    document.getElementById('execute_button').disabled = !this.checked;
});

// Load preview when both accounts are selected
function loadPreview() {
    const sourceId = document.getElementById('source_id').value;
    const targetId = document.getElementById('target_id').value;

    if (!sourceId || !targetId) {
        document.getElementById('preview_section').classList.add('d-none');
        return;
    }

    if (sourceId === targetId) {
        alert('Source and target accounts must be different!');
        return;
    }

    // Show preview section with loading indicator
    document.getElementById('preview_section').classList.remove('d-none');
    document.getElementById('preview_content').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading preview...</span>
            </div>
            <p class="mt-3 text-muted">Loading preview...</p>
        </div>
    `;

    // Set form values
    document.getElementById('form_source_id').value = sourceId;
    document.getElementById('form_target_id').value = targetId;

    // Fetch preview data
    const formData = new FormData();
    formData.append('source_id', sourceId);
    formData.append('target_id', targetId);

    // Get CSRF token from cookie
    const csrfToken = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrf_token='))
        ?.split('=')[1];

    fetch('/admin/users/merge/preview', {
        method: 'POST',
        headers: {
            'x-csrf-token': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderPreview(data.data);
        } else {
            document.getElementById('preview_content').innerHTML = `
                <div class="alert alert-danger">
                    <h5 class="alert-heading"><i class="bi bi-x-circle me-2"></i>Error</h5>
                    <p class="mb-0">${data.error}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById('preview_content').innerHTML = `
            <div class="alert alert-danger">
                <h5 class="alert-heading"><i class="bi bi-x-circle me-2"></i>Error</h5>
                <p class="mb-0">Failed to load preview: ${error.message}</p>
            </div>
        `;
    });
}

function renderPreview(preview) {
    const duplicateVotesHtml = preview.duplicate_poll_votes.length > 0 ? `
        <div class="alert alert-warning border-warning mt-3">
            <h6 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Duplicate Poll Votes Detected</h6>
            <p class="mb-2">Both accounts have voted on the following polls. The source account's votes will be <strong>deleted</strong>:</p>
            <ul class="mb-0">
                ${preview.duplicate_poll_votes.map(dv => `<li>${dv.poll_title}</li>`).join('')}
            </ul>
        </div>
    ` : '';

    const html = `
        <div class="row g-3">
            <div class="col-md-6">
                <div class="card bg-secondary h-100">
                    <div class="card-body">
                        <h6 class="card-title text-danger"><i class="bi bi-database-dash me-2"></i>Data Moving FROM</h6>
                        <p class="mb-1"><strong>${preview.source_angler.name}</strong></p>
                        <p class="text-muted small mb-0">${preview.source_angler.email || 'No email'}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-secondary h-100">
                    <div class="card-body">
                        <h6 class="card-title text-success"><i class="bi bi-database-add me-2"></i>Data Moving TO</h6>
                        <p class="mb-1"><strong>${preview.target_angler.name}</strong></p>
                        <p class="text-muted small mb-0">${preview.target_angler.email || 'No email'}</p>
                    </div>
                </div>
            </div>
        </div>

        ${duplicateVotesHtml}

        <h6 class="mt-4 mb-3"><i class="bi bi-list-check me-2"></i>Data to be Migrated</h6>
        <div class="row g-3">
            <div class="col-md-3">
                <div class="text-center p-3 bg-secondary rounded">
                    <h3 class="text-primary mb-1">${preview.results_count}</h3>
                    <small class="text-muted">Tournament Results</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3 bg-secondary rounded">
                    <h3 class="text-primary mb-1">${preview.team_results_angler1_count + preview.team_results_angler2_count}</h3>
                    <small class="text-muted">Team Results</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3 bg-secondary rounded">
                    <h3 class="text-primary mb-1">${preview.poll_votes_count}</h3>
                    <small class="text-muted">Poll Votes</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3 bg-secondary rounded">
                    <h3 class="text-primary mb-1">${preview.officer_positions_count}</h3>
                    <small class="text-muted">Officer Positions</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3 bg-secondary rounded">
                    <h3 class="text-muted mb-1">${preview.polls_created_count}</h3>
                    <small class="text-muted">Polls Created</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3 bg-secondary rounded">
                    <h3 class="text-muted mb-1">${preview.news_authored_count}</h3>
                    <small class="text-muted">News Articles</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3 bg-secondary rounded">
                    <h3 class="text-muted mb-1">${preview.tournaments_created_count}</h3>
                    <small class="text-muted">Tournaments Created</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3 bg-secondary rounded">
                    <h3 class="text-muted mb-1">${preview.proxy_votes_cast_count}</h3>
                    <small class="text-muted">Proxy Votes Cast</small>
                </div>
            </div>
        </div>
    `;

    document.getElementById('preview_content').innerHTML = html;
}

// Attach event listeners
document.getElementById('source_id').addEventListener('change', loadPreview);
document.getElementById('target_id').addEventListener('change', loadPreview);
</script>
{% endblock %}
