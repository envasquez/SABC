{% extends "base.html" %}

{% block title %}Create Generic Poll - South Austin Bass Club{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="display-5">
        <i class="bi bi-card-checklist me-2"></i>Create Generic Poll
    </h1>
    <p class="lead text-muted">Create a standalone poll not tied to any specific event</p>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <!-- Error and Success Messages -->
        {% if request.query_params.get('error') %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>{{ request.query_params.get('error') }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        {% if request.query_params.get('success') %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>{{ request.query_params.get('success') }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        {% if error %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <!-- Generic Poll Form -->
        <form method="POST" action="/admin/polls/create" id="generic-form">
            <input type="hidden" name="poll_type" value="generic">
            
            <div class="mb-3">
                <label for="title" class="form-label">Poll Title</label>
                <input type="text" class="form-control" id="title" name="title" 
                       placeholder="Enter poll title (e.g., Officer Election 2025)" required>
            </div>
            
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="2"
                          placeholder="Additional information about this poll"></textarea>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="starts_at" class="form-label">
                            <i class="bi bi-play-circle me-1 text-success"></i>Poll Starts
                        </label>
                        <input type="datetime-local" class="form-control" id="starts_at" name="starts_at">
                        <div class="form-text">When members can start voting</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="closes_at" class="form-label">
                            <i class="bi bi-stop-circle me-1 text-warning"></i>Poll Closes <span class="text-danger">*</span>
                        </label>
                        <input type="datetime-local" class="form-control" id="closes_at" name="closes_at" required>
                        <div class="form-text">When voting will end</div>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="form-label fw-semibold">
                    <i class="bi bi-list-ul me-2 text-primary"></i>Poll Options
                </label>
                <div class="form-text mb-3">Add the options that members can vote for. You need at least 2 options.</div>
                
                <div id="poll-options-container">
                    <div class="poll-option-row mb-2">
                        <div class="input-group">
                            <input type="text" class="form-control" name="poll_options[]" placeholder="Option 1" required>
                            <button class="btn btn-outline-danger" type="button" onclick="removeOption(this)" disabled>
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                    <div class="poll-option-row mb-2">
                        <div class="input-group">
                            <input type="text" class="form-control" name="poll_options[]" placeholder="Option 2" required>
                            <button class="btn btn-outline-danger" type="button" onclick="removeOption(this)" disabled>
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="btn btn-sm btn-outline-success" onclick="addOption()">
                    <i class="bi bi-plus-circle me-1"></i>Add Option
                </button>
            </div>
            
            <hr class="my-4">
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="/admin/polls/create" class="btn btn-secondary">Back</a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i>Create Generic Poll
                </button>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
// Generic poll option management
function addOption() {
    const container = document.getElementById('poll-options-container');
    const optionCount = container.children.length + 1;
    
    const optionRow = document.createElement('div');
    optionRow.className = 'poll-option-row mb-2';
    optionRow.innerHTML = `
        <div class="input-group">
            <input type="text" class="form-control" name="poll_options[]" placeholder="Option ${optionCount}" required>
            <button class="btn btn-outline-danger" type="button" onclick="removeOption(this)">
                <i class="bi bi-x"></i>
            </button>
        </div>
    `;
    
    container.appendChild(optionRow);
    updateRemoveButtons();
}

function removeOption(button) {
    const row = button.closest('.poll-option-row');
    row.remove();
    updateRemoveButtons();
    updatePlaceholders();
}

function updateRemoveButtons() {
    const container = document.getElementById('poll-options-container');
    const removeButtons = container.querySelectorAll('button[onclick*="removeOption"]');
    
    // Disable remove buttons if only 2 options remain
    removeButtons.forEach(button => {
        button.disabled = container.children.length <= 2;
    });
}

function updatePlaceholders() {
    const container = document.getElementById('poll-options-container');
    const inputs = container.querySelectorAll('input[name="poll_options[]"]');
    
    inputs.forEach((input, index) => {
        if (!input.value) {
            input.placeholder = `Option ${index + 1}`;
        }
    });
}

// Set intelligent defaults for poll timing
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    
    // Poll starts tomorrow at 6am
    const pollStart = new Date(today);
    pollStart.setDate(pollStart.getDate() + 1);
    pollStart.setHours(6, 0, 0, 0);
    
    // Poll closes in 1 week at 6pm
    const pollClose = new Date(today);
    pollClose.setDate(pollClose.getDate() + 7);
    pollClose.setHours(18, 0, 0, 0);
    
    // Format for datetime-local input (YYYY-MM-DDTHH:MM)
    function formatDateTimeLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    const formattedStart = formatDateTimeLocal(pollStart);
    const formattedClose = formatDateTimeLocal(pollClose);
    
    document.getElementById('starts_at').value = formattedStart;
    document.getElementById('closes_at').value = formattedClose;
    
    // Initialize remove button states
    updateRemoveButtons();
});
</script>
{% endblock %}
{% endblock %}