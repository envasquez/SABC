{% extends "base.html" %}
{% from 'macros.html' import alert, stat_card, delete_modal %}
{% block title %}Manage Anglers - South Austin Bass Club{% endblock %}
{% block content %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="display-5 mb-0"><i class="bi bi-people me-2"></i>Manage Anglers</h1>
            <p class="lead text-secondary mb-0">User administration</p>
        </div>
        <div>
            <a href="/admin/users/merge" class="btn btn-warning btn-lg me-2">
                <i class="bi bi-arrow-left-right me-2"></i>Merge Accounts
            </a>
            <button class="btn btn-primary btn-lg" onclick="showAddUserModal()">
                <i class="bi bi-person-plus me-2"></i>Add User
            </button>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-6 col-md-3">
            {{ stat_card('person-check', 'Active Members', active_member_count, 'success') }}
        </div>
        <div class="col-6 col-md-3">
            {{ stat_card('exclamation-triangle', 'Dues Overdue', overdue_member_count, 'danger') }}
        </div>
        <div class="col-6 col-md-3">
            {{ stat_card('person', 'Guests', guest_count, 'secondary') }}
        </div>
        <div class="col-6 col-md-3">
            {{ stat_card('people-fill', 'Total', total_count, 'primary') }}
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<ul class="nav nav-tabs mb-3" id="userTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="members-tab" data-bs-toggle="tab" data-bs-target="#members-pane" type="button" role="tab" aria-controls="members-pane" aria-selected="true">
            <i class="bi bi-person-check me-1"></i>Members <span class="badge bg-success ms-1">{{ active_member_count + overdue_member_count }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="guests-tab" data-bs-toggle="tab" data-bs-target="#guests-pane" type="button" role="tab" aria-controls="guests-pane" aria-selected="false">
            <i class="bi bi-person me-1"></i>Guests <span class="badge bg-secondary ms-1">{{ guest_count }}</span>
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="userTabsContent">
    <!-- Members Tab -->
    <div class="tab-pane fade show active" id="members-pane" role="tabpanel" aria-labelledby="members-tab">
        {% set members = users | selectattr('member') | list %}
        {% if members %}
        <table class="table table-dark table-striped">
            <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Officer</th><th>Actions</th></tr></thead>
            <tbody>
                {% for u in members %}
                <tr>
                    <td class="text-white">{{ u.name }}</td>
                    <td>{{ u.email or '-' }}</td>
                    <td>{{ u.phone or '-' }}</td>
                    <td>
                        {% if u.dues_paid_through | is_dues_current %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-danger" title="Dues overdue"><i class="bi bi-exclamation-triangle me-1"></i>Overdue</span>
                        {% endif %}
                        {% if u.is_admin %}<span class="badge bg-warning text-dark ms-1">Admin</span>{% endif %}
                    </td>
                    <td>
                        {% if u.officer_positions %}
                            {% for position in u.officer_positions.split(', ') %}
                                <span class="badge bg-info text-dark mb-1"><i class="bi bi-star-fill me-1"></i>{{ position }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-warning" onclick="location='/admin/users/{{ u.id }}/edit'"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-danger"
                                    {% if u.id == user.id %}
                                        disabled
                                    {% else %}
                                        onclick="deleteUser({{ u.id }}, '{{ u.name|e }}')"
                                    {% endif %}
                            ><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        {{ alert('info', 'No members found.') }}
        {% endif %}
    </div>

    <!-- Guests Tab -->
    <div class="tab-pane fade" id="guests-pane" role="tabpanel" aria-labelledby="guests-tab">
        {% set guests = users | rejectattr('member') | list %}
        {% if guests %}
        <table class="table table-dark table-striped">
            <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Actions</th></tr></thead>
            <tbody>
                {% for u in guests %}
                <tr>
                    <td class="text-white">{{ u.name }}</td>
                    <td>{{ u.email or '-' }}</td>
                    <td>{{ u.phone or '-' }}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-warning" onclick="location='/admin/users/{{ u.id }}/edit'"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-danger"
                                    {% if u.id == user.id %}
                                        disabled
                                    {% else %}
                                        onclick="deleteUser({{ u.id }}, '{{ u.name|e }}')"
                                    {% endif %}
                            ><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        {{ alert('info', 'No guests found.') }}
        {% endif %}
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Add New User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label for="addUserName" class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="addUserName" required placeholder="Enter full name">
                    </div>
                    <div class="mb-3">
                        <label for="addUserEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="addUserEmail" placeholder="email@example.com (optional)">
                        <small class="text-muted">If left blank for guests, a placeholder email will be generated</small>
                    </div>
                    <div class="mb-3">
                        <label for="addUserPhone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="addUserPhone" placeholder="(512) 555-1234 (optional)">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">User Type <span class="text-danger">*</span></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="userType" id="userTypeGuest" value="guest" checked>
                            <label class="form-check-label" for="userTypeGuest">
                                <i class="bi bi-person me-1"></i><strong>Guest</strong>
                                <br><small class="text-muted">Can fish tournaments, cannot vote in polls</small>
                            </label>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="radio" name="userType" id="userTypeMember" value="member">
                            <label class="form-check-label" for="userTypeMember">
                                <i class="bi bi-person-check me-1"></i><strong>Member</strong>
                                <br><small class="text-muted">Full club member with voting rights</small>
                            </label>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note:</strong> New users will receive an email with instructions to set their password (if email provided).
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddUser()">
                    <i class="bi bi-check-circle me-1"></i>Create User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
{% call delete_modal('deleteUserModal', 'Delete User', 'deleteUserName', 'confirmDeleteBtn', 'deleteConfirmInput') %}
<p class="text-secondary">This will remove all user data and cannot be reversed.</p>
{% endcall %}

<script src="/static/admin-users.js"></script>
{% endblock %}
