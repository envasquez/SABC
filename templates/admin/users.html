{% extends "base.html" %}
{% from 'macros.html' import alert, stat_card %}
{% block title %}Manage Anglers - South Austin Bass Club{% endblock %}
{% block content %}
<div class="mb-4">
    <h1 class="display-5"><i class="bi bi-people me-2"></i>Manage Anglers</h1>
    <p class="lead text-secondary">User administration</p>
    <div class="row mb-3">
        <div class="col-md-3">
            {{ stat_card('person-check', 'Members', member_count, 'success') }}
        </div>
        <div class="col-md-3">
            {{ stat_card('person', 'Guests', guest_count, 'secondary') }}
        </div>
        <div class="col-md-3">
            {{ stat_card('people-fill', 'Total', total_count, 'primary') }}
        </div>
    </div>
</div>
<table class="table table-dark table-striped">
    <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Officer</th><th>Actions</th></tr></thead>
    <tbody>
        {% for u in users %}
        <tr>
            <td class="text-white">{{ u.name }}</td>
            <td>{{ u.email or '-' }}</td>
            <td>{{ u.phone or '-' }}</td>
            <td>
                {% if u.member %}
                    <span class="badge bg-success">Member</span>
                {% else %}
                    <span class="badge bg-secondary">Guest</span>
                {% endif %}
                {% if u.is_admin %}<span class="badge bg-danger ms-1">Admin</span>{% endif %}
            </td>
            <td>
                {% if u.officer_positions %}
                    {% for position in u.officer_positions.split(', ') %}
                        <span class="badge bg-info text-dark mb-1"><i class="bi bi-star-fill me-1"></i>{{ position }}</span>
                    {% endfor %}
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-warning" onclick="location='/admin/users/{{ u.id }}/edit'"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-danger"
                            {% if u.id == user.id %}
                                disabled
                            {% else %}
                                onclick="deleteUser({{ u.id }}, '{{ u.name|e }}')"
                            {% endif %}
                    ><i class="bi bi-trash"></i></button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{{ alert('info', 'No users found.' if not users else None) }}

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Delete User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>⚠️ Warning:</strong> This action cannot be undone.
                </div>
                <p>You are about to permanently delete the user:</p>
                <p><strong id="deleteUserName"></strong></p>
                <p class="text-secondary">This will remove all user data and cannot be reversed.</p>
                <p><strong>Type "DELETE" to confirm:</strong></p>
                <input type="text" class="form-control" id="deleteConfirmInput" placeholder="Type DELETE to confirm" autocomplete="off">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                    <i class="bi bi-trash me-1"></i>Delete User
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let deleteUserId = null;

function deleteUser(userId, userName) {
    console.log('deleteUser called with:', userId, userName);
    deleteUserId = userId;
    document.getElementById('deleteUserName').textContent = userName;
    document.getElementById('deleteConfirmInput').value = ''; // Clear the input
    document.getElementById('confirmDeleteBtn').disabled = true; // Disable button initially
    new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
}

// Enable/disable delete button based on confirmation input
document.getElementById('deleteConfirmInput').addEventListener('input', function(e) {
    const btn = document.getElementById('confirmDeleteBtn');
    btn.disabled = e.target.value !== 'DELETE';
});

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (deleteUserId && document.getElementById('deleteConfirmInput').value === 'DELETE') {
        fetch(`/admin/users/${deleteUserId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting user: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting user: ' + error.message);
        });
        
        bootstrap.Modal.getInstance(document.getElementById('deleteUserModal')).hide();
    }
});
</script>
{% endblock %}