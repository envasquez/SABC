{% extends "base.html" %}
{% from 'macros.html' import alert, badge, csrf_token, delete_modal %}

{% block title %}Polls - South Austin Bass Club{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="display-5">
        <i class="bi bi-card-checklist me-2"></i>Club Polls
    </h1>
    <p class="lead text-secondary">Member voting and tournament location polls</p>
</div>

<!-- Error and Success Messages -->
{{ alert('danger', request.query_params.get('error')) }}
{{ alert('success', request.query_params.get('success')) }}

<div class="row g-4">
    {% if polls %}
        {% for poll in polls %}
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header {{ 'bg-success' if poll.status == 'closed' else ('bg-warning' if poll.status == 'active' else 'bg-secondary') }} text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            {{ poll.title }}
                            {% if poll.status == 'closed' %}
                                <span class="badge bg-warning text-dark ms-2">CLOSED</span>
                            {% elif poll.status == 'active' %}
                                <span class="badge bg-light text-dark ms-2">ACTIVE</span>
                            {% elif poll.status == 'upcoming' %}
                                <span class="badge bg-info ms-2">UPCOMING</span>
                            {% endif %}
                        </h5>
                        <small>
                            Poll Opens on {{ poll.starts_at.strftime('%m-%d-%Y at %H:%M') }} | Closes on {{ poll.closes_at.strftime('%m-%d-%Y at %H:%M') }}
                        </small>
                    </div>
                    {% if user and user.is_admin %}
                    <div class="btn-group">
                        <button class="btn btn-sm btn-warning"
                                onclick="window.location.href='/admin/polls/{{ poll.id }}/edit'">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger"
                                onclick="deletePoll({{ poll.id }}, '{{ poll.title|e }}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if poll.description %}
                    <div class="mb-3">
                        <p class="text-secondary">{{ poll.description }}</p>
                    </div>
                    {% endif %}

                    {% if poll.options %}
                        {% if poll.status == 'active' and user.member and not poll.user_has_voted %}
                            <!-- Voting Interface -->
                            <form method="POST" action="/polls/{{ poll.id }}/vote">
                                {{ csrf_token(request) }}
                                <div class="mb-3">
                                    <p class="fw-bold text-primary">
                                        <i class="bi bi-check-circle me-2"></i>Cast your vote:
                                    </p>
                                    {% if poll.poll_type == 'tournament_location' %}
                                    <!-- Tournament location polls - interactive selection -->
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <!-- Three Column Layout -->
                                            <div class="row g-3">
                                                <!-- Lake Selection -->
                                                <div class="col-md-4">
                                                    <label for="lake_select" class="form-label fw-bold small">
                                                        <i class="bi bi-geo-alt me-1"></i>Lake
                                                    </label>
                                                    <select id="lake_select" class="form-select form-select-sm" required onchange="updateRamps()">
                                                        <option value="">Choose a lake...</option>
                                                    </select>
                                                </div>

                                                <!-- Ramp Selection -->
                                                <div class="col-md-4">
                                                    <label for="ramp_select" class="form-label fw-bold small">
                                                        <i class="bi bi-signpost me-1"></i>Ramp
                                                    </label>
                                                    <select id="ramp_select" class="form-select form-select-sm" required disabled>
                                                        <option value="">First select a lake</option>
                                                    </select>
                                                </div>

                                                <!-- Time Selection -->
                                                <div class="col-md-4">
                                                    <label class="form-label fw-bold small">
                                                        <i class="bi bi-clock me-1"></i>Times
                                                    </label>
                                                    <div class="d-flex gap-2">
                                                        <div class="flex-fill">
                                                            <select id="start_time" class="form-select form-select-sm" required title="Start Time">
                                                                <option value="">Start...</option>
                                                                <option value="05:00" selected>5:00 AM</option>
                                                                <option value="05:30">5:30 AM</option>
                                                                <option value="06:00">6:00 AM</option>
                                                                <option value="06:30">6:30 AM</option>
                                                                <option value="07:00">7:00 AM</option>
                                                                <option value="07:30">7:30 AM</option>
                                                                <option value="08:00">8:00 AM</option>
                                                                <option value="08:30">8:30 AM</option>
                                                                <option value="09:00">9:00 AM</option>
                                                                <option value="09:30">9:30 AM</option>
                                                                <option value="10:00">10:00 AM</option>
                                                                <option value="10:30">10:30 AM</option>
                                                                <option value="11:00">11:00 AM</option>
                                                                <option value="11:30">11:30 AM</option>
                                                                <option value="12:00">12:00 PM</option>
                                                                <option value="12:30">12:30 PM</option>
                                                                <option value="13:00">1:00 PM</option>
                                                                <option value="13:30">1:30 PM</option>
                                                                <option value="14:00">2:00 PM</option>
                                                                <option value="14:30">2:30 PM</option>
                                                                <option value="15:00">3:00 PM</option>
                                                                <option value="15:30">3:30 PM</option>
                                                                <option value="16:00">4:00 PM</option>
                                                                <option value="16:30">4:30 PM</option>
                                                                <option value="17:00">5:00 PM</option>
                                                                <option value="17:30">5:30 PM</option>
                                                                <option value="18:00">6:00 PM</option>
                                                                <option value="18:30">6:30 PM</option>
                                                                <option value="19:00">7:00 PM</option>
                                                                <option value="19:30">7:30 PM</option>
                                                                <option value="20:00">8:00 PM</option>
                                                            </select>
                                                            <small class="text-secondary d-block text-center mt-1">Start</small>
                                                        </div>
                                                        <div class="flex-fill">
                                                            <select id="end_time" class="form-select form-select-sm" required title="End Time">
                                                                <option value="">End...</option>
                                                                <option value="05:00">5:00 AM</option>
                                                                <option value="05:30">5:30 AM</option>
                                                                <option value="06:00">6:00 AM</option>
                                                                <option value="06:30">6:30 AM</option>
                                                                <option value="07:00">7:00 AM</option>
                                                                <option value="07:30">7:30 AM</option>
                                                                <option value="08:00">8:00 AM</option>
                                                                <option value="08:30">8:30 AM</option>
                                                                <option value="09:00">9:00 AM</option>
                                                                <option value="09:30">9:30 AM</option>
                                                                <option value="10:00">10:00 AM</option>
                                                                <option value="10:30">10:30 AM</option>
                                                                <option value="11:00">11:00 AM</option>
                                                                <option value="11:30">11:30 AM</option>
                                                                <option value="12:00">12:00 PM</option>
                                                                <option value="12:30">12:30 PM</option>
                                                                <option value="13:00">1:00 PM</option>
                                                                <option value="13:30">1:30 PM</option>
                                                                <option value="14:00">2:00 PM</option>
                                                                <option value="14:30">2:30 PM</option>
                                                                <option value="15:00" selected>3:00 PM</option>
                                                                <option value="15:30">3:30 PM</option>
                                                                <option value="16:00">4:00 PM</option>
                                                                <option value="16:30">4:30 PM</option>
                                                                <option value="17:00">5:00 PM</option>
                                                                <option value="17:30">5:30 PM</option>
                                                                <option value="18:00">6:00 PM</option>
                                                                <option value="18:30">6:30 PM</option>
                                                                <option value="19:00">7:00 PM</option>
                                                                <option value="19:30">7:30 PM</option>
                                                                <option value="20:00">8:00 PM</option>
                                                            </select>
                                                            <small class="text-secondary d-block text-center mt-1">End</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Vote Preview -->
                                            <div class="mt-3 p-3 border rounded bg-light d-none" id="vote_preview">
                                                <h6 class="mb-2 text-dark">Your Vote:</h6>
                                                <div id="vote_summary" class="text-dark"></div>
                                            </div>

                                            <input type="hidden" name="option_id" id="vote_option_id" required>
                                        </div>
                                    </div>

                                    {% else %}
                                    <!-- Regular polls - single column -->
                                    {% for option in poll.options %}
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="option_id"
                                               id="option_{{ option.id }}" value="{{ option.id }}" required>
                                        <label class="form-check-label" for="option_{{ option.id }}">
                                            {{ option.text }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                                <button type="submit" class="btn btn-primary" {% if poll.poll_type == 'tournament_location' %}onclick="return validateVote()"{% endif %}>
                                    <i class="bi bi-check2 me-1"></i>Cast Vote
                                </button>
                            </form>
                        {% elif poll.status == 'active' and not user.member %}
                            <!-- Non-member message -->
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Only club members can vote in polls.
                            </div>
                        {% elif poll.status == 'upcoming' %}
                            <!-- Poll not yet open -->
                            <div class="alert alert-info">
                                <i class="bi bi-clock me-2"></i>
                                This poll will open for voting on {{ poll.starts_at.strftime('%Y-%m-%d') }} at {{ poll.starts_at.strftime('%H:%M') }}.
                            </div>
                        {% else %}
                        {% endif %}

                        <!-- Always show results if there are any votes -->
                        {% if poll.status == 'closed' or poll.user_has_voted or (poll.options | sum(attribute='vote_count')) > 0 %}
                            <div class="mt-3">
                                {% set total_votes = poll.options | sum(attribute='vote_count') %}
                                {% if poll.poll_type == 'tournament_location' %}
                                <!-- Tournament location polls - interactive bar chart -->
                                <div class="tournament-results-container"
                                     data-poll-type="tournament_location"
                                     data-poll-id="{{ poll.id }}"
                                     class="d-none">
                                    <!-- Hidden data elements for JavaScript -->
                                    {% for option in poll.options %}
                                    <div data-option-id="{{ option.id }}"
                                         data-option-text="{{ option.option_text | escape }}"
                                         data-option-data='{{ option.option_data if option.option_data else "{}" }}'
                                         data-vote-count="{{ option.vote_count }}"
                                         class="d-none"></div>
                                    {% endfor %}
                                    <div class="row">
                                        <!-- Two-Level Bar Chart (Left Panel) -->
                                        <div class="col-lg-8">
                                            <!-- Lake Level Chart -->
                                            <div class="card border-0 shadow-sm mb-3">
                                                <div class="card-header bg-success text-white py-2">
                                                    <h6 class="mb-0"><i class="bi bi-geo-alt me-1"></i>Lakes</h6>
                                                </div>
                                                <div class="card-body p-3">
                                                    <div class="lakes-chart-container" id="lakesChart">
                                                        <!-- Lakes chart will be drawn here -->
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Ramp Level Chart -->
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-header bg-success text-white py-2 d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0"><i class="bi bi-signpost me-1"></i>Ramps</h6>
                                                    <small id="selectedLake" class="opacity-75">Click a lake above</small>
                                                </div>
                                                <div class="card-body p-3">
                                                    <div class="ramps-chart-container" id="rampsChart">
                                                        <div class="text-secondary text-center py-4">
                                                            <i class="bi bi-arrow-up me-2"></i>Select a lake above to see ramp breakdown
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Time Slots Table (Right Panel) -->
                                        <div class="col-lg-4">
                                            <div class="card border-0 shadow-sm h-100">
                                                <div class="card-header bg-dark text-white py-2">
                                                    <h6 class="mb-0"><i class="bi bi-clock me-1"></i>Time Slots</h6>
                                                </div>
                                                <div class="card-body p-2">
                                                    <div class="time-table-container">
                                                        <table class="table table-sm table-hover mb-0" id="timeTable">
                                                            <thead class="table-light sticky-top">
                                                                <tr>
                                                                    <th class="text-dark fw-semibold" class="small">Start</th>
                                                                    <th class="text-dark fw-semibold" class="small">End</th>
                                                                    <th class="text-dark fw-semibold text-center" class="small">Votes</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <!-- Time slots will be populated by JavaScript -->
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Vote count summary for tournament polls -->
                                    <div class="text-center mt-3 text-secondary">
                                        <small><i class="bi bi-people-fill me-1"></i>{{ total_votes }} member{{ 's' if total_votes != 1 else '' }} voted</small>
                                    </div>
                                </div>
                                {% else %}
                                <!-- Regular polls - vertical bar chart results -->
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-primary text-white py-2">
                                        <h6 class="mb-0"><i class="bi bi-bar-chart-fill me-1"></i>Poll Results</h6>
                                    </div>
                                    <div class="card-body p-3">
                                        <!-- Vertical Bar Chart Container -->
                                        <div class="d-flex align-items-end justify-content-around mb-4 mt-2" style="height: 180px; position: relative;">
                                            {% set max_votes = poll.options | map(attribute='vote_count') | max %}
                                            {% for option in poll.options %}
                                                {% if option.vote_count > 0 %}
                                                {% set percentage = (option.vote_count / total_votes * 100) if total_votes > 0 else 0 %}
                                                {% set bar_height = (option.vote_count / max_votes * 140) if max_votes > 0 else 0 %}
                                                {% set colors = ['#0d6efd', '#198754', '#fd7e14', '#dc3545', '#6f42c1', '#20c997', '#ffc107'] %}
                                                {% set color = colors[loop.index0 % colors|length] %}

                                                <div class="text-center d-flex flex-column align-items-center justify-content-end" style="flex: 1; max-width: 120px;">
                                                    <!-- The vertical bar with vote count inside -->
                                                    <div class="rounded-top position-relative d-flex align-items-start justify-content-center"
                                                         style="height: {{ bar_height if bar_height > 20 else (20 if option.vote_count > 0 else 0) }}px;
                                                                width: 40px;
                                                                background: linear-gradient(to top, {{ color }}, {{ color }}dd);
                                                                transition: all 0.6s ease-in-out;
                                                                box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                                         onmouseover="this.style.transform='scaleY(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                                                         onmouseout="this.style.transform='scaleY(1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                                                        {% if option.vote_count > 0 %}
                                                            <span class="fw-bold text-white small" style="margin-top: 4px;">{{ option.vote_count }}</span>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Option text below bar -->
                                                    <div class="mt-2 small text-center" style="max-width: 80px; line-height: 1.2;">
                                                        <span class="fw-medium text-white">{{ option.text }}</span>
                                                        <div class="text-secondary small">{{ "%.1f" | format(percentage) }}%</div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <!-- Vote count summary for generic polls -->
                                    <div class="text-center mt-4 text-secondary">
                                        <small><i class="bi bi-people-fill me-1"></i>{{ total_votes }} member{{ 's' if total_votes != 1 else '' }} voted</small>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% else %}
                        <!-- No options -->
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            This poll has no voting options yet.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="col-12">
        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body text-white py-4">
                <h4 class="mb-3"><i class="bi bi-inbox me-2"></i>No Polls Available</h4>
                <p class="mb-0 opacity-90">There are currently no polls available. Check back later!</p>
                {% if user and user.is_admin %}
                <hr class="border-white opacity-25">
                <p class="mb-0">
                    <a href="/admin/polls/create" class="btn btn-light btn-sm">
                        <i class="bi bi-plus-circle me-1 text-dark"></i><span class="text-dark">Create New Poll</span>
                    </a>
                </p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Delete Poll Confirmation Modal -->
<div class="modal fade" id="deletePollModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Delete Poll</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>⚠️ Warning:</strong> This action cannot be undone.
                </div>
                <p>You are about to permanently delete the poll:</p>
                <p><strong id="deletePollTitle"></strong></p>
                <p class="text-secondary">This will remove the poll, all options, and all votes. This cannot be reversed.</p>
                <p><strong>Type "DELETE" to confirm:</strong></p>
                <input type="text" class="form-control" id="deletePollConfirmInput" placeholder="Type DELETE to confirm" autocomplete="off">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeletePollBtn" disabled>
                    <i class="bi bi-trash me-1"></i>Delete Poll
                </button>
            </div>
        </div>
    </div>
</div>

<script src="/static/polls.js"></script>
<script src="/static/admin.js"></script>
<script>
// Populate lake dropdown on page load
const lakesData = {{ lakes_data | tojson | safe }};

document.addEventListener('DOMContentLoaded', function() {
    const lakeSelect = document.getElementById('lake_select');
    if (lakeSelect && lakesData) {
        lakesData.forEach(lake => {
            const option = document.createElement('option');
            option.value = lake.id;
            option.textContent = lake.name;
            lakeSelect.appendChild(option);
        });
    }
});

function updateRamps() {
    const lakeSelect = document.getElementById('lake_select');
    const rampSelect = document.getElementById('ramp_select');

    if (!lakeSelect || !rampSelect) return;

    const lakeId = parseInt(lakeSelect.value);
    rampSelect.innerHTML = '<option value="">Select a ramp...</option>';
    rampSelect.disabled = true;

    if (!lakeId) return;

    const selectedLake = lakesData.find(lake => lake.id === lakeId);
    if (selectedLake && selectedLake.ramps) {
        selectedLake.ramps.forEach(ramp => {
            const option = document.createElement('option');
            option.value = ramp.id;
            option.textContent = ramp.name;
            rampSelect.appendChild(option);
        });
        if (selectedLake.ramps.length > 0) {
            rampSelect.disabled = false;
        }
    }
}

function validateVote() {
    const lakeSelect = document.getElementById('lake_select');
    const rampSelect = document.getElementById('ramp_select');
    const startTimeSelect = document.getElementById('start_time');
    const endTimeSelect = document.getElementById('end_time');
    const voteDataInput = document.getElementById('vote_option_data');

    if (!lakeSelect.value) {
        alert('Please select a lake');
        return false;
    }
    if (!rampSelect.value) {
        alert('Please select a ramp');
        return false;
    }
    if (!startTimeSelect.value) {
        alert('Please select a start time');
        return false;
    }
    if (!endTimeSelect.value) {
        alert('Please select an end time');
        return false;
    }

    // Validate time order - start time must be before end time
    if (startTimeSelect.value >= endTimeSelect.value) {
        alert('Start time must be before end time');
        return false;
    }

    // Validate reasonable tournament hours (4 AM to 11 PM)
    const startHour = parseInt(startTimeSelect.value.split(':')[0]);
    const endHour = parseInt(endTimeSelect.value.split(':')[0]);
    if (startHour < 4 || endHour > 23) {
        alert('Tournament times must be between 4:00 AM and 11:00 PM');
        return false;
    }

    // Create JSON object with vote data
    const voteData = {
        lake_id: lakeSelect.value,
        ramp_id: rampSelect.value,
        start_time: startTimeSelect.value,
        end_time: endTimeSelect.value
    };

    // Set the hidden field value to JSON string
    voteDataInput.value = JSON.stringify(voteData);
    return true;
}

let deletePollId = null;

function deletePoll(pollId, pollTitle) {
    deletePollId = pollId;
    document.getElementById('deletePollTitle').textContent = pollTitle;
    document.getElementById('deletePollConfirmInput').value = '';
    document.getElementById('confirmDeletePollBtn').disabled = true;
    new bootstrap.Modal(document.getElementById('deletePollModal')).show();
}

// Enable/disable delete button based on confirmation input
document.getElementById('deletePollConfirmInput').addEventListener('input', function(e) {
    const btn = document.getElementById('confirmDeletePollBtn');
    btn.disabled = e.target.value !== 'DELETE';
});

document.getElementById('confirmDeletePollBtn').addEventListener('click', function() {
    if (deletePollId && document.getElementById('deletePollConfirmInput').value === 'DELETE') {
        // Get CSRF token from cookie
        const csrfToken = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrf_token='))
            ?.split('=')[1];

        fetch(`/admin/polls/${deletePollId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'x-csrf-token': csrfToken,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting poll: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting poll: ' + error.message);
        });

        bootstrap.Modal.getInstance(document.getElementById('deletePollModal')).hide();
    }
});
</script>
{% endblock %}
