{% extends "base.html" %}
{% from 'macros.html' import alert, csrf_token %}

{% block title %}Photo Gallery - SABC{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-images"></i> Photo Gallery</h1>
        {% if user and user.member %}
        <a href="/photos/upload" class="btn btn-primary">
            <i class="bi bi-upload me-1"></i> Upload Photo
        </a>
        {% endif %}
    </div>

    {{ alert('success', request.query_params.get('success')) }}
    {{ alert('danger', request.query_params.get('error')) }}

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" action="/photos" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="tournament_id" class="form-label">Tournament</label>
                    <select class="form-select" id="tournament_id" name="tournament_id">
                        <option value="">All Tournaments</option>
                        {% for t in tournament_options %}
                        <option value="{{ t.id }}" {% if selected_tournament == t.id %}selected{% endif %}>
                            {{ t.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="angler_id" class="form-label">Angler</label>
                    <select class="form-select" id="angler_id" name="angler_id">
                        <option value="">All Anglers</option>
                        {% for a in angler_options %}
                        <option value="{{ a.id }}" {% if selected_angler == a.id %}selected{% endif %}>
                            {{ a.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="big_bass" name="big_bass" value="true"
                               {% if selected_big_bass %}checked{% endif %}>
                        <label class="form-check-label" for="big_bass">
                            <i class="bi bi-trophy-fill text-warning"></i> Big Bass Only
                        </label>
                    </div>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-secondary">
                        <i class="bi bi-funnel me-1"></i> Filter
                    </button>
                    <a href="/photos" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-1"></i> Clear
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Photo Grid -->
    {% if photos %}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
        {% for photo in photos %}
        <div class="col">
            <div class="card h-100">
                <a href="{{ photo.url }}" class="gallery-link" data-caption="{{ photo.caption or '' }}">
                    <img src="{{ photo.url }}" class="card-img-top" alt="{{ photo.caption or 'Photo' }}"
                         style="height: 200px; object-fit: cover;" loading="lazy">
                </a>
                <div class="card-body p-2">
                    {% if photo.is_big_bass %}
                    <span class="badge bg-warning text-dark mb-1">
                        <i class="bi bi-trophy-fill"></i> Big Bass
                    </span>
                    {% endif %}
                    {% if photo.caption %}
                    <p class="card-text small mb-1">{{ photo.caption }}</p>
                    {% endif %}
                    <p class="card-text small text-muted mb-0">
                        <i class="bi bi-person"></i> {{ photo.angler_name }}
                        {% if photo.tournament_name %}
                        <br><i class="bi bi-calendar"></i> {{ photo.tournament_name }}
                        {% endif %}
                    </p>
                </div>
                {% if photo.can_edit or photo.can_delete %}
                <div class="card-footer p-2">
                    {% if photo.can_edit %}
                    <a href="/photos/{{ photo.id }}/edit" class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                    {% endif %}
                    {% if photo.can_delete %}
                    <form method="post" action="/photos/{{ photo.id }}/delete" class="d-inline"
                          onsubmit="return confirm('Are you sure you want to delete this photo?');">
                        {{ csrf_token(request) }}
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </form>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="bi bi-images display-1 text-secondary"></i>
        <p class="text-secondary mt-3">No photos yet.</p>
        {% if user and user.member %}
        <a href="/photos/upload" class="btn btn-primary">
            <i class="bi bi-upload me-1"></i> Upload the first photo!
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Lightbox Modal -->
<div class="modal fade" id="lightboxModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header border-0">
                <span id="lightboxCaption" class="text-white"></span>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="lightboxImage" src="" class="img-fluid" style="max-height: 80vh;">
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('lightboxModal'));
    const lightboxImage = document.getElementById('lightboxImage');
    const lightboxCaption = document.getElementById('lightboxCaption');

    document.querySelectorAll('.gallery-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            lightboxImage.src = this.href;
            lightboxCaption.textContent = this.dataset.caption || '';
            modal.show();
        });
    });
});
</script>
{% endblock %}
