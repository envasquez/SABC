{% extends "base.html" %}
{% block title %}Calendar - South Austin Bass Club{% endblock %}
{% block content %}
<div class="mb-4">
    <h1 class="display-5"><i class="bi bi-calendar3 me-2"></i>Club Calendar</h1>
    <p class="lead text-secondary">Tournament Schedule & Holidays</p>
</div>

<!-- Year Tabs -->
<ul class="nav nav-tabs mb-3" id="yearTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="current-year-tab" data-bs-toggle="tab" data-bs-target="#current-year" type="button" role="tab" aria-controls="current-year" aria-selected="true">
            {{ current_year }}
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="next-year-tab" data-bs-toggle="tab" data-bs-target="#next-year" type="button" role="tab" aria-controls="next-year" aria-selected="false">
            {{ next_year }}
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="yearTabContent">
    <!-- Current Year Tab -->
    <div class="tab-pane fade show active" id="current-year" role="tabpanel" aria-labelledby="current-year-tab">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white text-center">
                <h4 class="mb-0">{{ current_year }} Calendar</h4>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    {% for m in current_calendar_data %}
                    {% set month_num = loop.index %}
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-secondary text-light text-center py-1">
                                <small class="fw-bold">{{m[0]}}</small>
                            </div>
                            <div class="card-body p-1">
                                <table class="table table-sm mb-0 small table-dark">
                                    <thead>
                                        <tr>
                                            {% for d in ['S','M','T','W','T','F','S'] %}
                                            <th class="text-center p-0" style="width:14%;">{{d}}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for w in m[1] %}
                                        <tr>
                                            {% for d in w %}
                                            <td class="text-center p-0 {% if '†' in d %}bg-primary text-white calendar-event{% elif '§' in d %}bg-success text-white calendar-event{% elif '‡' in d %}bg-warning text-dark calendar-event{% elif '*' in d %}bg-danger text-white calendar-event{% endif %}"
                                                style="height:20px;line-height:20px;{% if '†' in d or '§' in d or '‡' in d or '*' in d %}cursor:pointer;{% endif %}"
                                                {% if '†' in d or '§' in d or '‡' in d or '*' in d %}
                                                data-year="{{ current_year }}"
                                                data-month="{{ month_num }}"
                                                data-day="{{ d.replace('†','').replace('§','').replace('‡','').replace('*','') }}"
                                                onclick="showEventDetails(this)"
                                                {% endif %}>
                                                {% if d %}{{d.replace('†','').replace('§','').replace('‡','').replace('*','')}}{% endif %}
                                            </td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="card-footer text-center">
                <div class="row">
                    {% if 'sabc_tournament' in event_types_present %}
                    <div class="col">
                        <span class="badge bg-primary me-2">&nbsp;</span>SABC Tournaments
                    </div>
                    {% endif %}
                    {% if 'other_tournament' in event_types_present %}
                    <div class="col">
                        <span class="badge bg-warning text-dark me-2">&nbsp;</span>Other Tournaments
                    </div>
                    {% endif %}
                    {% if 'holiday' in event_types_present %}
                    <div class="col">
                        <span class="badge bg-danger me-2">&nbsp;</span>Holidays
                    </div>
                    {% endif %}
                    {% if 'club_event' in event_types_present %}
                    <div class="col">
                        <span class="badge bg-success me-2">&nbsp;</span>Club Events
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Next Year Tab -->
    <div class="tab-pane fade" id="next-year" role="tabpanel" aria-labelledby="next-year-tab">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white text-center">
                <h4 class="mb-0">{{ next_year }} Calendar</h4>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    {% for m in next_calendar_data %}
                    {% set month_num = loop.index %}
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-secondary text-light text-center py-1">
                                <small class="fw-bold">{{m[0]}}</small>
                            </div>
                            <div class="card-body p-1">
                                <table class="table table-sm mb-0 small table-dark">
                                    <thead>
                                        <tr>
                                            {% for d in ['S','M','T','W','T','F','S'] %}
                                            <th class="text-center p-0" style="width:14%;">{{d}}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for w in m[1] %}
                                        <tr>
                                            {% for d in w %}
                                            <td class="text-center p-0 {% if '†' in d %}bg-primary text-white calendar-event{% elif '§' in d %}bg-success text-white calendar-event{% elif '‡' in d %}bg-warning text-dark calendar-event{% elif '*' in d %}bg-danger text-white calendar-event{% endif %}"
                                                style="height:20px;line-height:20px;{% if '†' in d or '§' in d or '‡' in d or '*' in d %}cursor:pointer;{% endif %}"
                                                {% if '†' in d or '§' in d or '‡' in d or '*' in d %}
                                                data-year="{{ next_year }}"
                                                data-month="{{ month_num }}"
                                                data-day="{{ d.replace('†','').replace('§','').replace('‡','').replace('*','') }}"
                                                onclick="showEventDetails(this)"
                                                {% endif %}>
                                                {% if d %}{{d.replace('†','').replace('§','').replace('‡','').replace('*','')}}{% endif %}
                                            </td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="card-footer text-center">
                <div class="row">
                    {% if 'sabc_tournament' in event_types_present %}
                    <div class="col">
                        <span class="badge bg-primary me-2">&nbsp;</span>SABC Tournaments
                    </div>
                    {% endif %}
                    {% if 'other_tournament' in event_types_present %}
                    <div class="col">
                        <span class="badge bg-warning text-dark me-2">&nbsp;</span>Other Tournaments
                    </div>
                    {% endif %}
                    {% if 'holiday' in event_types_present %}
                    <div class="col">
                        <span class="badge bg-danger me-2">&nbsp;</span>Holidays
                    </div>
                    {% endif %}
                    {% if 'club_event' in event_types_present %}
                    <div class="col">
                        <span class="badge bg-success me-2">&nbsp;</span>Club Events
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Event details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script>
// Event details data from server
const currentEventDetails = {{ current_event_details_json|safe }};
const nextEventDetails = {{ next_event_details_json|safe }};

function showEventDetails(element) {
    const year = element.getAttribute('data-year');
    const month = element.getAttribute('data-month');
    const day = element.getAttribute('data-day');
    const eventKey = month + '-' + day;

    // Select the appropriate event details based on year
    const eventDetails = (year == '{{ current_year }}') ? currentEventDetails : nextEventDetails;

    if (eventDetails[eventKey]) {
        const events = eventDetails[eventKey];
        const eventDate = events[0].date;
        const dateObj = new Date(eventDate + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Set modal title
        document.getElementById('eventModalTitle').innerHTML = formattedDate;

        // Build modal body content
        let modalContent = '';
        events.forEach(function(event, index) {
            let eventTypeIcon = '';
            let eventTypeName = '';
            let eventTypeClass = '';

            if (event.type === 'holiday') {
                eventTypeIcon = '<i class="bi bi-calendar-x me-2"></i>';
                eventTypeName = 'Federal Holiday';
                eventTypeClass = 'bg-danger';
            } else if (event.type === 'sabc_tournament') {
                eventTypeIcon = '<i class="bi bi-trophy me-2"></i>';
                eventTypeName = 'SABC Tournament';
                eventTypeClass = 'bg-primary';
            } else if (event.type === 'other_tournament') {
                eventTypeIcon = '<i class="bi bi-calendar-event me-2"></i>';
                eventTypeName = 'Other Tournament';
                eventTypeClass = 'bg-warning text-dark';
            } else if (event.type === 'club_event') {
                eventTypeIcon = '<i class="bi bi-people me-2"></i>';
                eventTypeName = 'Club Event';
                eventTypeClass = 'bg-success';
            } else if (event.type === 'generic_event') {
                eventTypeIcon = '<i class="bi bi-calendar me-2"></i>';
                eventTypeName = 'Event';
                eventTypeClass = 'bg-secondary';
            }

            modalContent += '<div class="mb-3">';
            modalContent += '<div class="d-flex align-items-center mb-2">';
            modalContent += '<span class="badge ' + eventTypeClass + ' me-2">' + eventTypeIcon + eventTypeName + '</span>';
            modalContent += '</div>';
            modalContent += '<h6 class="mb-2">' + event.title + '</h6>';
            if (event.description) {
                modalContent += '<p class="text-secondary mb-0">' + event.description + '</p>';
            }

            // Add tournament details if available (for sabc_tournament and other_tournament)
            // For SABC tournaments with active polls, only show lake/ramp (times are in the poll)
            // For other tournaments, show all details including times
            if (event.type === 'sabc_tournament' || event.type === 'other_tournament') {
                const showTimes = event.type === 'other_tournament' || !event.poll_id;
                if (event.lake_name || (showTimes && (event.start_time || event.end_time))) {
                    modalContent += '<div class="mt-2 small text-muted">';
                    if (event.lake_name) {
                        modalContent += '<div><i class="bi bi-geo-alt me-1"></i><strong>Lake:</strong> ' + event.lake_name;
                        if (event.ramp_name) {
                            modalContent += ' - ' + event.ramp_name;
                        }
                        modalContent += '</div>';
                    }
                    if (showTimes && event.start_time) {
                        modalContent += '<div><i class="bi bi-clock me-1"></i><strong>Start:</strong> ' + event.start_time + '</div>';
                    }
                    if (showTimes && event.end_time) {
                        modalContent += '<div><i class="bi bi-clock-fill me-1"></i><strong>Weigh-in:</strong> ' + event.end_time + '</div>';
                    }
                    modalContent += '</div>';
                }
            }

            // Add poll and tournament links if available
            if (event.poll_id) {
                if (event.poll_status === 'active') {
                    modalContent += '<div class="mt-2">';
                    modalContent += '<a href="' + event.poll_link + '" class="btn btn-primary btn-sm me-2">';
                    modalContent += '<i class="bi bi-hand-thumbs-up me-1"></i>Vote in Poll</a>';
                    modalContent += '</div>';
                } else if (event.poll_status === 'closed' || event.poll_status === 'results') {
                    modalContent += '<div class="mt-2">';
                    modalContent += '<a href="' + event.poll_link + '" class="btn btn-secondary btn-sm me-2">';
                    modalContent += '<i class="bi bi-bar-chart me-1"></i>View Poll Results</a>';
                    modalContent += '</div>';
                }
            }

            if (event.tournament_link) {
                modalContent += '<div class="mt-2">';
                modalContent += '<a href="' + event.tournament_link + '" class="btn btn-success btn-sm">';
                modalContent += '<i class="bi bi-trophy me-1"></i>View Tournament Results</a>';
                modalContent += '</div>';
            }

            modalContent += '</div>';

            if (index < events.length - 1) {
                modalContent += '<hr>';
            }
        });

        // Set modal body
        document.getElementById('eventModalBody').innerHTML = modalContent;

        // Show modal
        new bootstrap.Modal(document.getElementById('eventModal')).show();
    }
}
</script>

{% endblock %}
